/* (c) Mathigon */
var app=function(exports){'use strict';function nearlyEquals(e,s,n=tolerance){return _Mathabs(e-s)<n}function isBetween(e,s,n,i=tolerance){const t=s>n?[n,s]:[s,n],a=t[0],r=t[1];return e>a+i&&e<r-i}function addThousandSeparators(e){e=(''+e).split('.');let t=e[0];for(;NUM_REGEX.test(t);)t=t.replace(NUM_REGEX,'$1,$2');return t+(1<e.length?'.'+e[1]:'')}function addPowerSuffix(e,t){if(!t)return e;const s=(''+_Mathabs(_Mathfloor(e))).length,n=0>e?1:0;if(s<=t-n)return _round(e,t-s-n-1);const i=_Mathfloor(_Mathlog(_Mathabs(e))/3);return _round(e/_Mathpow(10,3*i),t-(s%3||3)-n-1)+POWER_SUFFIX[i]}function numberFormat(e,t){return addThousandSeparators(addPowerSuffix(e,t)).replace('-','\u2013')}function fmt(e){let s=('00'+e).substr(-3),n=s[0],i=s[1],t=s[2];return[0===+n?'':ONES[n]+' hundred ',0===+t?TENS[i]:TENS[i]&&TENS[i]+'-'||'',ONES[i+t]||ONES[t]].join('')}function cons(e,t,s){return t?[t,s&&' '+s||'',' ',e].join(''):e}function toWord(e){if(!e)return'zero';let t='',s=0;for(;e;)t=cons(t,fmt(e%1e3),MULTIPLIERS[s]),s+=1,e=0|e/1e3;return t.trim()}function _round(e,t=0){let s=_Mathpow(10,t);return _Mathround(e*s)/s}function roundTo(e,t=1){return _Mathround(e/t)*t}function facRec(e,t){return 1>=e?e:e*facRec(e-1,t)}function factorial(e){return 0===e?1:0>e?NaN:facRec(e,1)}function permutations(e){function t(e){for(let a,r=0;r<e.length;r++)a=e.splice(r,1)[0],n.push(a),0===e.length&&s.push(n.slice()),t(e),e.splice(r,0,a),n.pop();return s}let s=[],n=[];return t(e)}function _getSubsets(e){if(1===e.length)return[[],e];let t=e.pop(),n=_getSubsets(e),i=[];for(let a of n){let e=a.slice(0);e.push(t),i.push(a,e)}return i}function subsets(e,t=0){let s=e.slice(0),n=_getSubsets(s);return t&&(n=n.filter((e)=>e.length===t)),n}function run(e,...t){return e instanceof Function?e(...t):e}function clamp(e,t=-Infinity,s=Infinity){return _Mathmin(s,_Mathmax(t,e))}function square(e){return e*e}function _tabulateWith(e,t,s){if(!s.length)return run(e,...t);let n=s.slice(0),a=n.shift(),r=[];for(let o=0;o<a;++o)r.push(_tabulateWith(e,t.concat([o]),n));return r}function tabulate(e,...t){return _tabulateWith(e,[],t)}function list(e,t,s=1){let n=[];if(null==t&&0<=e)for(let t=0;t<e;t+=s)n.push(t);else if(null==t)for(let t=0;t>e;t-=s)n.push(t);else if(e<=t)for(let a=e;a<=t;a+=s)n.push(a);else for(let a=e;a>=t;a-=s)n.push(a);return n}function total(e){return e.length?+e.reduce((e,t)=>e+(+t||0)):0}function flatten(e){return e.reduce((e,t)=>e.concat(Array.isArray(t)?flatten(t):t),[])}function difference(e,t){let s=t.filter((t)=>!e.includes(t)),n=e.filter((e)=>!t.includes(e));return[...s,...n]}function toLinkedList(e){const t=e.map((e)=>({val:e,next:null})),s=t.length;for(let n=0;n<s;++n)t[n].next=t[(n+1)%s];return t}function isString(e){return e instanceof String||'string'==typeof e}function isNumber(e){return e instanceof Number||'number'==typeof e}function isArray(e){return Array.isArray(e)}function substitute(e,t){if(isNumber(e))return e;if(isString(e))return e in t?t[e]:e;let s=e[0],n=e.slice(1);return n=n.map((e)=>substitute(e,t)),[s,...n]}function same(e,t){if(e===t)return!0;if(!isArray(e)||!isArray(t))return!1;if(e[0]!==t[0])return!1;let s=e[0],n=e.slice(1),r=t.slice(1);if('+*'.includes(s)){let e=permutations(n);return e.some((e)=>e.every((e,t)=>same(e,r[t])))}return n.every((e,t)=>same(e,r[t]))}function flattenAssociative(e){if(isString(e)||isNumber(e))return e;let t=e[0],s=e.slice(1);if(s=s.map((e)=>flattenAssociative(e)),!'+*'.includes(t))return[t,...s];let n=[];for(let i of s)isArray(i)&&i[0]==t?n.push(...i.slice(1)):n.push(i);return[t,...n]}function mergePlaceholders(e){if(!e.length)return[];for(let t of e)if(!t.length)return[];let t=tabulate(function(...t){let s=t.map((t,s)=>e[s][t]),n={};for(let e of s){if(!e)return null;for(let t of Object.keys(e))if(!(t in n))n[t]=e[t];else if(!same(n[t],e[t]))return null}return n},...e.map((e)=>e.length));return flatten(t).filter((e)=>!!e)}function match(e,t){if(isNumber(t))return e===t?[{}]:[];if(isString(t))return'c'==t[0]?isNumber(e)?[{[t]:e}]:[]:'v'==t[0]?isString(e)?[{[t]:e}]:[]:[{[t]:e}];if(!isArray(e))return[];let s=e[0],n=e.slice(1);if(s!=t[0])return[];if(e.length!=t.length)return[];if('+*'.includes(e[0])){for(let e of permutations(n)){let s=mergePlaceholders(e.map((e,s)=>match(e,t[s+1])));if(s.length)return s}return[]}return mergePlaceholders(n.map((e,s)=>match(e,t[s+1])))}function rewrite(e,t){if(isString(e)||isNumber(e))return e;let s=e[0],n=e.slice(1);n=n.map((e)=>rewrite(e,t));let i=t[0],a=i[0],r=i.slice(1);if('+*'.includes(s)&&'+*'.includes(a)&&n.length>r.length){for(let e of subsets(list(n.length),r.length)){let i=e.map((e)=>n[e]),a=n.filter((t,s)=>!e.includes(s)),r=match([s,...i],t[0])[0];if(r){let e=substitute(t[1],r);return flattenAssociative([s,e,...a])}}return[s,...n]}let o=match([s,...n],t[0])[0];return o?substitute(t[1],o):[s,...n]}function simplify(e){HAS_GENERATED_RULES||(REWRITE_RULES=REWRITE_RULES.map((e)=>[parseString(e[0]),parseString(e[1])]).reverse(),HAS_GENERATED_RULES=!0);for(let t=toString(e),s=null;s!=t;){s=t,e=evaluate(e),e=flattenAssociative(e);for(let t of REWRITE_RULES)e=rewrite(e,t);t=toString(e)}return e}function evaluate(e,t={}){if(isNumber(e))return e;if(isString(e))return e in t?t[e]:e in CONSTANTS?CONSTANTS[e]:e;let s=e[0],n=e.slice(1);if(n=n.map((e)=>evaluate(e,t)),n.every((e)=>isNumber(e))){if(s in t)return t[s](...n);if(s in FN_EVALUATE)return FN_EVALUATE[s](...n);if(s in Math)return Math[s](...n)}else if('+*'.includes(s)){let e=FN_EVALUATE[s](...n.filter((e)=>isNumber(e))),t=n.filter((e)=>!isNumber(e));return[s,e,...t]}return[s,...n]}function needsBrackets(e,t){return!(isNumber(e)||isString(e))&&PRECEDENCE.indexOf(t)<PRECEDENCE.indexOf(e[0])}function stringify(e){if(isNumber(e)||isString(e))return e;let t=e[0],s=e.slice(1);return s=s.map((e)=>needsBrackets(e,t)?`(${stringify(e)})`:stringify(e)),t in FN_STRINGIFY?FN_STRINGIFY[t](...s):t+'('+s.join(', ')+')'}function mathML(e){if(isNumber(e))return`<mn>${e}</mn>`;if(isString(e))return`<mi>${e}</mi>`;const t=e[0],s=e.slice(1),n=s.map((e)=>needsBrackets(e,t)?`<mfenced>${mathML(e)}</mfenced>`:mathML(e));return'sqrt'===t?`<msqrt>${mathML(s[0])}</msqrt>`:'/'===t?`<mfrac><mrow>${mathML(s[0])}</mrow><mrow>${mathML(s[1])}</mrow></mfrac>`:'^'===t?`<msup>${n[0]}<mrow>${mathML(s[1])}</mrow></msup>`:'*'===t?n.join('<mo value="\xD7">\xD7</mo>'):'+'===t?n.join('<mo value="+">+</mo>'):'-'===t?n.join('<mo value="\u2013">\u2013</mo>'):`<mi>TODO</mi>`}function variables(e){if(isNumber(e))return[];if(isString(e))return[e];let t=[];for(let s of e.slice(1))for(let e of variables(s))t.includes(e)||t.push(e);return t}function functions(e){if(isNumber(e)||isString(e))return[];let t=[e[0]];for(let s of e.slice(1))for(let e of functions(s))t.includes(e)||t.push(e);return t}function findBinaryFunction(e,t){for(let s=0;s<e.length;++s)if(t.includes(e[s])){let t=e[s-1],n=e[s+1];if(null==n)throw new ExprError('SyntaxError',`An expression cannot end with a “${e[s]}”.`);if('+-*/^%!'.includes(t))throw new ExprError('SyntaxError',`A “${t}” cannot be followed by a “${e[s]}”.`);if('+-*/^%!'.includes(n))throw new ExprError('SyntaxError',`A “${e[s]}” cannot be followed by a “${n}”.`);e.splice(s-1,3,[e[s],t,n]),s-=2}}function parseMaths(e){for(let s,n=0;n<e.length;++n)s=e[n],s==+s&&(e[n]=+s);if('+*/^%!'.includes(e[0]))throw new ExprError('SyntaxError',`A term cannot start with a “${e[0]}”.`);for(let t=0;t<e.length;++t)'!%'.includes(e[t])&&(e.splice(t-1,2,[e[t],e[t-1]]),t-=1);findBinaryFunction(e,'^'),findBinaryFunction(e,'*/');for(let t=0;t<e.length-1;++t)'+-*/^%!'.includes(e[t])||'+-*/^%!'.includes(e[t+1])||(e.splice(t,2,['*',e[t],e[t+1]]),t-=1);if('-\xB1'.includes(e[0])){if(1>=e.length)throw new ExprError('SyntaxError',`This expression is invalid.`);e.splice(0,2,[e[0],e[1]])}if(findBinaryFunction(e,'+-\xB1'),findBinaryFunction(e,'=<>\u2264\u2265'),1<e.length)throw new ExprError('SyntaxError',`This expression is invalid.`);return e[0]}function matchBrackets(e){let s=[];for(let n,t=0;t<e.length;++t){if(n=e[t],')]}'.includes(n)||'|'==n&&0<t)return[parseMaths(s),e.slice(t)];if('([{|'.includes(n)){let i=s.pop();if('%!'.includes(i))throw new ExprError('SyntaxError',`A “${i}” cannot be followed by a “${n}”.`);let a=matchBrackets(e.slice(t+1)),r=a[0],o=a[1],l=o[0],d=o.slice(1);if(l!=BRACKETS[n])throw new ExprError('SyntaxError',`The brackets “${n}” and "${l}” don’t match.`);'|'==n&&(r=['abs',r]),i&&i.match(/^\w+$/)&&i!=+i?s.push([i,r]):i?s.push(i,r):s.push(r),e=d,t=-1}else s.push(n)}return[parseMaths(s),[]]}function parseString(e){let t=e.replace(TOKEN_REGEX,'').trim();if(t)throw new ExprError('SyntaxError',`The character “${t[0]}” is invalid.`);let s=e.match(TOKEN_REGEX);for(let t=0;t<s.length;++t)s[t]in TOKEN_REPLACE&&(s[t]=TOKEN_REPLACE[s[t]]);let n=matchBrackets(s),i=n[0],a=n[1];if(a.length)throw new ExprError('SyntaxError',`The character “${a[0][0]}” shouldn’t be here.`);return i}function rad(e,t=origin){const s=_Mathatan(e.y-t.y,e.x-t.x);return(s+twoPi)%twoPi}function liesOnSegment(e,t){return nearlyEquals(e.p1.x,e.p2.x)?isBetween(t.y,e.p1.y,e.p2.y):isBetween(t.x,e.p1.x,e.p2.x)}function liesOnRay(e,t){return nearlyEquals(e.p1.x,e.p2.x)?0<(t.y-e.p1.y)/(e.p2.y-e.p1.y):0<(t.x-e.p1.x)/(e.p2.x-e.p1.x)}function lineLineIntersection(e,t){const s=e.p1.x-e.p2.x,n=e.p1.y-e.p2.y,i=t.p1.x-t.p2.x,a=t.p1.y-t.p2.y,r=s*a-n*i;if(nearlyEquals(r,0))return[];const o=e.p1.x*e.p2.y-e.p1.y*e.p2.x,l=t.p1.x*t.p2.y-t.p1.y*t.p2.x;return[new Point((o*i-s*l)/r,(o*a-n*l)/r)]}function circleCircleIntersection(e,t){const s=Point.distance(e.c,t.c);if(s>e.r+t.r)return[];if(s<_Mathabs(e.r-t.r))return[];if(nearlyEquals(s,0)&&nearlyEquals(e.r,t.r))return[];if(nearlyEquals(s,e.r+t.r))return[new Line(e.c,t.c).midpoint];const n=(square(e.r)-square(t.r)+square(s))/(2*s),i=_Mathsqrt(square(e.r)-square(n)),a=(t.c.x-e.c.x)*n/s+(t.c.y-e.c.y)*i/s+e.c.x,r=(t.c.y-e.c.y)*n/s-(t.c.x-e.c.x)*i/s+e.c.y,o=(t.c.x-e.c.x)*n/s-(t.c.y-e.c.y)*i/s+e.c.x,l=(t.c.y-e.c.y)*n/s+(t.c.x-e.c.x)*i/s+e.c.y;return[new Point(a,r),new Point(o,l)]}function lineCircleIntersection(){return[]}function intersections(...e){if(2>e.length)return[];if(2<e.length)return flatten(subsets(e,2).map((t)=>intersections(...t)));const t=e[0],s=e[1];if(t instanceof Polygon||t instanceof Rectangle)return intersections(s,...t.edges);if(s instanceof Polygon||t instanceof Rectangle)return intersections(t,...s.edges);let n=[];return t instanceof Line&&s instanceof Line?n=lineLineIntersection(t,s):t instanceof Line&&s instanceof Circle?n=lineCircleIntersection(t,s):t instanceof Circle&&s instanceof Line?n=lineCircleIntersection(s,t):t instanceof Circle&&s instanceof Circle&&(n=circleCircleIntersection(t,s)),t instanceof Segment&&(n=n.filter((e)=>liesOnSegment(t,e))),s instanceof Segment&&(n=n.filter((e)=>liesOnSegment(s,e))),t instanceof Ray&&(n=n.filter((e)=>liesOnRay(t,e))),s instanceof Ray&&(n=n.filter((e)=>liesOnRay(s,e))),n}function shuffle(e){e=e.slice(0);for(let s,n=e.length-1;0<n;--n){s=_Mathfloor(Math.random()*(n+1));var t=[e[s],e[n]];e[n]=t[0],e[s]=t[1]}return e}function intArray(e){let t=[];for(let s=0;s<e;++s)t.push(s);return shuffle(t)}function uniform(e=0,t=1){return e+(t-e)*Math.random()}function noop$1(){}function run$1(e,...t){return e instanceof Function?e(...t):e}function isOneOf$1(e,...t){for(let s of t)if(e===s)return!0;return!1}function deepExtend$1(e,t){for(let s of Object.keys(t))s in e&&Array.isArray(e[s])&&Array.isArray(t[s])?e[s]=e[s].concat(t[s]):s in e&&e[s]instanceof Object&&t[s]instanceof Object?deepExtend$1(e[s],t[s]):e[s]=t[s]}function clamp$1(e,t=-Infinity,s=Infinity){return _Mathmin(s,_Mathmax(t,e))}function square$1(e){return e*e}function delay$1(e,s=0){return s?setTimeout(e,s):void e()}function wait$1(e){return new Promise((t)=>setTimeout(t,e))}function defer$1(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return s.catch(function(e){return e}),{promise:s,resolve:e,reject:t}}function throttle$1(e,s=0){let t=!1,n=!1;return function(...i){t?n=!0:(e.apply(null,i),t=!0,setTimeout(function(){n&&e(...i),t=!1,n=!1},s))}}function _tabulateWith$1(e,t,s){if(!s.length)return run$1(e,...t);let n=s.slice(0),a=n.shift(),r=[];for(let o=0;o<a;++o)r.push(_tabulateWith$1(e,t.concat([o]),n));return r}function tabulate$1(e,...t){return _tabulateWith$1(e,[],t)}function last$1(e,t=0){return e[e.length-1-t]}function total$1(e){return e.length?+e.reduce((e,t)=>e+(+t||0)):0}function sortBy$1(e,t,s=!1){return e.slice(0).sort((e,n)=>e[t]<n[t]?s?1:-1:e[t]>n[t]?s?-1:1:0)}function sortByFn$1(e,t,s=!1){return e.slice(0).sort((e,n)=>{let i=t(e),a=t(n);return i<a?s?1:-1:i>a?s?-1:1:0})}function loop$1(e){let t=0;return()=>e[t++%e.length]}function without$1(e,t){return e.filter((e)=>e!==t)}function cumulative$1(e){let t=0;return e.map((e)=>t+=e)}function process$1(e,t){return t.lowercase&&(e=e.toLowerCase()),e.split(t.split).map((t)=>t.trim())}function words$1(e){return e?e.trim().split(/\s+/):[]}function toCamelCase$1(e){return e.toLowerCase().replace(/^-/,'').replace(/-(.)/g,(e,t)=>t.toUpperCase())}function repeat$1(e,t=1){for(let s=1;s<t;++s)e+=e;return e}function stringDistance$1(e,t){let s=tabulate$1(0,e.length+1,t.length+1);for(let n=0;n<=e.length;n++)s[n][0]=n;for(let n=0;n<=t.length;n++)s[0][n]=n;for(let n=1;n<=e.length;n++)for(let i=1;i<=t.length;i++)s[n][i]=_Mathmin(s[n-1][i-1]+(e.charAt(n-1)===t.charAt(i-1)?0:1),s[n-1][i]+1,s[n][i-1]+1);return s[e.length][t.length]}function autocorrect$1(e,t){let s=e.length/2,n=t.map((t)=>({w:t,d:stringDistance$1(e,t)})).filter(({d:e})=>e<s),i=sortBy$1(n,'d')[0];return i?i.w:null}function isString$1(e){return e instanceof String||'string'==typeof e}function animate(e,t){function s(){a&&(!t||i<=t)&&window.requestAnimationFrame(s),i=Date.now()-n,e(t?_Mathmin(1,i/t):i),t&&i>=t&&r.resolve()}if(0===t)return void e();let n=Date.now(),i=0,a=!0,r=defer$1(),o=r.promise.then.bind(r.promise);return s(),{cancel:function(){a=!1,r.reject()},then:o}}function easeIn(e,n,i){return'quad'===e?n*n:'cubic'===e?n*n*n:'quart'===e?n*n*n*n:'quint'===e?n*n*n*n*n:'circ'===e?1-_Mathsqrt(1-n*n):'sine'===e?1-_Mathcos(n*_MathPI/2):'exp'===e?0>=n?0:_Mathpow(2,10*(n-1)):'back'===e?(i||(i=1.70158),n*n*((i+1)*n-i)):'elastic'===e?(i||(i=.3),-_Mathpow(2,10*(n-1))*_Mathsin((2*(n-1)/i-.5)*_MathPI)):'swing'===e?.5-_Mathcos(n*_MathPI)/2:'spring'===e?1-_Mathcos(4.5*n*_MathPI)*Math.exp(6*-n):'bounce'===e?n<1/11?1/64-7.5625*(.5/11-n)*(.5/11-n):n<3/11?1/16-7.5625*(2/11-n)*(2/11-n):n<7/11?1/4-7.5625*(5/11-n)*(5/11-n):1-7.5625*(1-n)*(1-n):n}function ease(e,n=0,t=0){return 0===n?0:1===n?1:(e=e.split('-'),'in'===e[1]?easeIn(e[0],n,t):'out'===e[1]?1-easeIn(e[0],1-n,t):.5>=n?easeIn(e[0],2*n,t)/2:1-easeIn(e[0],2*(1-n),t)/2)}function transition(t,s,e=400,n=0,i='ease-in-out'){if(!isReady)return Object.keys(s).forEach((e)=>{let n=s[e];t.css(e,Array.isArray(n)?n[1]:n)}),Promise.resolve();t._data._animation&&t._data._animation.cancel();const a={},r={},o=defer$1(),l=window.getComputedStyle(t._el);Object.keys(s).forEach((e)=>{const i=s[e],o=toCamelCase$1(e);r[o]=Array.isArray(i)?i[0]:l.getPropertyValue(e),a[o]=Array.isArray(i)?i[1]:i,n&&t.css(e,r[o])});let d=a.height;'auto'===a.height&&(a.height=total$1(t.children.map((e)=>e.outerHeight))+'px');let p,c=!1;delay$1(()=>{c||(p=t._el.animate([r,a],{duration:e,easing:i,fill:'forwards'}),p.onfinish=function(n){t._el&&Object.keys(s).forEach((e)=>t.css(e,'height'===e?d:a[e])),o.resolve(n),p.cancel()})},n);const h={then:o.promise.then.bind(o.promise),cancel(){c=!0,t._el&&Object.keys(s).forEach((e)=>t.css(e,t.css(e))),p&&p.cancel()}};return setTimeout(()=>t._data._animation=h),h}function enter(e,t='fade',s=500,n=0){if(e.show(),!isReady)return Promise.resolve();if('fade'===t)return transition(e,{opacity:[0,1]},s,n);if('pop'===t){const t=e.transform.replace(/scale\([0-9.]*\)/,'').replace(cssMatrix,'translate($1px,$2px)');return transition(e,{opacity:[0,1]},s,n),transition(e,{transform:[t+' scale(0.5)',t+' scale(1)']},s,n,'cubic-bezier(0.175, 0.885, 0.32, 1.275)')}if('descend'===t){return transition(e,{opacity:[0,1],transform:['translateY(-50%)','none']},s,n)}if('draw'===t){const t=e.strokeLength+'px';return e.css({opacity:1,"stroke-dasharray":t}),transition(e,{"stroke-dashoffset":[t,0]},s,n,'linear').then(()=>e.css('stroke-dasharray',''))}if(t.startsWith('slide')){const i={opacity:[0,1],transform:['translateY(50px)','none']};return t.includes('down')&&(i.transform[0]='translateY(-50px)'),transition(e,i,s,n)}if(t.startsWith('reveal')){const i={opacity:[0,1],height:[0,'auto']};return t.includes('left')&&(i.transform=['translateX(-50%)','none']),t.includes('right')&&(i.transform=['translateX(50%)','none']),transition(e,i,s,n)}}function exit(e,t='fade',s=400,n=0,i=!1){if(!e._el)return Promise.resolve();if(!isReady)return e.hide(),Promise.resolve();if('none'===e.css('display'))return Promise.resolve();let a;if('fade'===t)a=transition(e,{opacity:[1,0]},s,n);else if('pop'===t){const t=e.transform.replace(/scale\([0-9.]*\)/,'');transition(e,{opacity:[1,0]},s,n),a=transition(e,{transform:[t+' scale(1)',t+' scale(0.5)']},s,n,'cubic-bezier(0.68, -0.275, 0.825, 0.115)')}else if('ascend'===t){a=transition(e,{opacity:[1,0],transform:['none','translateY(-50%)']},s,n)}else if('draw'===t){const t=e.strokeLength+'px';e.css('stroke-dasharray',t),a=transition(e,{"stroke-dashoffset":[0,t]},s,n,'linear')}else if(t.startsWith('slide')){const i={opacity:0,transform:'translateY(50px)'};t.includes('up')&&(i.transform='translateY(-50px)'),a=transition(e,i,s,n)}else if(t.startsWith('reveal')){const i={opacity:0,height:0};t.includes('left')&&(i.transform='translateX(-50%)'),t.includes('right')&&(i.transform='translateX(50%)'),a=transition(e,i,s,n)}return a.then(()=>i?e.remove():e.hide()),a}function effect(e,t){e.animationEnd(function(){e.removeClass('effects-'+t)}),e.addClass('effects-'+t)}function redraw(){document.body.offsetHeight}function resize(e=null){e?(e({width,height}),browserEvents.on('resize',e)):doResize()}function afterLoad(){if(!loaded){loaded=!0;for(let e of loadQueue)e();setTimeout(resize)}}function ready(e){loaded?e():loadQueue.push(e)}function cssTimeToNumber(e){let t=/^([\-\+]?[0-9]+(\.[0-9]+)?)(m?s)$/,s=t.exec(e.trim());return null===s?null:+s[1]*('s'===s[3]?1e3:1)}function addCSS(e){let t=document.createElement('style');t.type='text/css',t.innerHTML=e,document.head.appendChild(t)}function addCSSRule(e,t){let s=document.styleSheets[document.styleSheets.length-1],n=s.cssRules.length-1;s.insertRule?s.insertRule(e+'{'+t+'}',n):s.addRule(e,t,n)}function getCookies(){let e=document.cookie.split(';'),t={};for(let s,a=0,i=e.length;a<i;++a)s=e[a].split('='),s[0]=s[0].replace(/^\s+|\s+$/,''),t[decodeURIComponent(s[0])]=decodeURIComponent(s[1]);return t}function getCookie(e){let t=document.cookie.match(new RegExp(`(^|;) ?${e}=([^;]*)(;|$)`));return t?t[2]:null}function setCookie(e,t,s=31536000){document.cookie=e+'='+t+';path=/;max-age='+s}function deleteCookie(e){setCookie(e,'',-1)}function setStorage(e,t){let s=(e||'').split('.'),n=JSON.parse(window.localStorage.getItem(STORAGE_KEY))||{},a=n;for(let n=0;n<s.length-1;++n)null==a[s[n]]&&(a[s[n]]={}),a=a[s[n]];a[s[s.length-1]]=t,window.localStorage.setItem(STORAGE_KEY,JSON.stringify(n))}function getStorage(e){let t=JSON.parse(window.localStorage.getItem(STORAGE_KEY))||{};if(!e)return t;const s=(e||'').split('.'),n=s.pop();for(let n of s){if(!(n in t))return null;t=t[n]}return t[n]}function deleteStorage(e){e?setStorage(e,null):window.localStorage.setItem(STORAGE_KEY,'')}function activeInput(){let e=document.activeElement;return e===document.body?void 0:$(e)}function onKey(t,s){t=words$1(t).map((e)=>keyCodes[e]||e),document.addEventListener('keydown',function(n){let e=activeInput();e&&e.is('input, textarea, [contenteditable]')||0<=t.indexOf(n.keyCode)&&s(n)})}function replaceSvgImports(){if(polyfill){let e=Array.from(document.querySelectorAll('svg > use'));e.forEach(function(e){let t=e.getAttribute('xlink:href'),s=t.split('#'),n=s[0],i=s[1];if(!n.length)return;let a=e.parentNode;a.removeChild(e),n in requests||(requests[n]=get(n));let r=requests[n];r.then(function(e){let t=document.implementation.createHTMLDocument('');t.documentElement.innerHTML=e;let s=t.getElementById(i),n=s.cloneNode(!0),r=document.createDocumentFragment();for(;n.childNodes.length;)r.appendChild(n.firstChild);a.appendChild(r)})})}}function pointerPosition(t){if('touches'in t){let e=t.targetTouches.length?t.targetTouches:t.changedTouches;return new Point(e[0].clientX,e[0].clientY)}return new Point(t.clientX,t.clientY)}function svgPointerPosn(e,t){let s=pointerPosition(e);return s.transform(t.inverseTransformMatrix)}function canvasPointerPosition(e,t){const s=pointerPosition(e),n=t.bounds,i=(s.x-n.left)*t._el.width/n.width,a=(s.y-n.top)*t._el.height/n.height;return new Point(i,a)}function makeClickEvent(t){if(t._events._click)return;if(t._events._click=!0,!navigator.userAgent.match(/iP(ad|hone|od)/g))return void t._el.addEventListener('click',function(s){t.trigger('click',s)});let s;t._el.addEventListener('touchstart',function(t){1==t.touches.length&&(s=pointerPosition(t))}),t._el.addEventListener('touchend',function(n){if(s){let e=pointerPosition(n);5>_Mathabs(e.x-s.x)&&5>_Mathabs(e.y-s.y)&&t.trigger('click',n),s=null}}),t._el.addEventListener('touchcancel',function(){s=null})}function makeClickOutsideEvent(t){t._events._clickOutside||(t._events._clickOutside=!0,$body.on('click',function(s){$(s.target).hasParent(t)||t.trigger('clickOutside')}))}function slide(t,s){function e(t){t.preventDefault(),t.handled||t.touches&&1<t.touches.length||(t.handled=!0,'move'in s&&d.on('pointermove',n),d.on('pointerstop',i),o=l=r(t),'start'in s&&s.start(o))}function n(t){t.preventDefault(),a||(a=!0,window.requestAnimationFrame(function(){if(a){const e=r(t);s.move(e,o,l),l=e,a=!1}}))}function i(t){t.preventDefault(),t.touches&&0<t.touches.length||(a=!1,'move'in s&&d.off('pointermove',n),d.off('pointerstop',i),'end'in s&&s.end(l,o))}let a=!1,r=pointerPosition;if('SVG'===t.tagName)r=(s)=>svgPointerPosn(s,t);else if('CANVAS'===t.tagName)r=(s)=>canvasPointerPosition(s,t);else if(t instanceof SVGElement){const s=t.parents('svg')[0];r=(t)=>svgPointerPosn(t,s)}let o,l,d=s.justInside?t:$body;'auto'===t.css('touch-action')&&t.css('touch-action','none'),t.on('pointerdown',e),s.justInside&&t.on('mouseleave',i)}function makeScrollEvents(e){function t(){let s=e.scrollTop;return s==r?void(a=!1):void(r=s,e.trigger('scroll',{top:r}),window.requestAnimationFrame(t))}function s(){a||window.requestAnimationFrame(t),a=!0}function n(){window.addEventListener('touchmove',s),window.addEventListener('touchend',i)}function i(){window.removeEventListener('touchmove',s),window.removeEventListener('touchend',i)}if(e._data._scrollEvents)return;e._data._scrollEvents=!0;let a=!1,r=null,o=e instanceof WindowElement?window:e._el;o.addEventListener('scroll',s),e._el.addEventListener('touchstart',function(t){t.handled||n()})}function makeHoverEvent(e,t){let s=null,n=!1,i=!1;e.on('mouseover',()=>{clearTimeout(s),s=delay$1(()=>{n||(t.enter(),i=!0,n=!0)},t.delay)}),e.on('mouseout',()=>{clearTimeout(s),s=delay$1(()=>{n&&(t.exit&&t.exit(),n=!1)},t.delay)});const a=t.$clickTarget||e;a.on('click',()=>{n&&!i?(t.exit&&t.exit(),n=!1):!n&&(t.enter(),i=!1,n=!0)}),e.on('clickOutside',()=>{n&&(t.exit&&t.exit(),n=!1)})}function intersectionCallback(t){for(let s of t){const e=s.isIntersecting?'enterViewport':'exitViewport';setTimeout(()=>$(s.target).trigger(e))}}function makeIntersectionEvents(e){if(!e._data.intersectionEvents){if(e._data.intersectionEvents=!0,!window.IntersectionObserver){let t=!1;return void $body.on('scroll',()=>{let s=e.isInViewport;t&&!s?(e.trigger('exitViewport'),t=!1):s&&!t&&(e.trigger('enterViewport'),t=!0)})}observer||(observer=new IntersectionObserver(intersectionCallback)),observer.observe(e._el)}}function checkInside(e,t){let s=pointerPosition(e),n=document.elementFromPoint(s.x,s.y);return isOneOf$1(t._el,n,n.parentNode,n.parentNode.parentNode)}function makePointerPositionEvents(t){if(t._data._pointerEvents)return;t._data._pointerEvents=!0;let e=t.parent,s=null;e.on('pointerend',function(){s=null}),e.on('pointermove',function(n){let e=s;s=checkInside(n,t),null!=e&&s&&!e&&t.trigger('pointerenter',n),!s&&e&&t.trigger('pointerleave',n)})}function makeMouseEvent(t,s){s._events['_'+t]||(s._events['_'+t]=!0,s._el.addEventListener(t,function(n){touchEnabled||s.trigger(t,n)}))}function createEvent(e,t,s,n){t in e._events?0>e._events[t].indexOf(s)&&e._events[t].push(s):e._events[t]=[s],t in aliases?e.on(aliases[t],s,n):t in customEvents?customEvents[t](e,s):e._el.addEventListener(t,s,n)}function removeEvent(e,t,s,n){if(t in e._events&&(e._events[t]=without$1(e._events[t],s)),t in aliases)e.off(aliases[t],s,n);else if(t in customEvents);else e._el.removeEventListener(t,s,n)}function observable(e={}){function t(t,s){i[t]=s,t in e||Object.defineProperty(e,t,{get:()=>i[t],set(s){i[t]=s,e.update()}})}let s=[],i={},a=1,n=ALPHABETH.split('').map((e)=>'_'+e);for(let s of Object.keys(e))t(s,e[s]);return e.update=function(){for(let e of s)e(i)},e.watch=function(e,t=!1){s.push(e),t||e(i)},e.set=function(s,n){i[s]===n||(t(s,n),e.update())},e.assign=function(s){for(let e of Object.keys(s))t(e,s[e]);e.update()},e.name=function(){return n.length||(a+=1,n=ALPHABETH.split('').map((e)=>repeat$1('_',a)+e)),n.pop()},e}function parse(t,e=!1){let s=t.replace(/×/g,'*');e||(s=s.replace(/"/g,'"').replace(/\$\{([^\}]+)\}/g,(e,t)=>`" + (${t}) + "`),s='"'+s+'"');try{return new Function('_vars',`try {
      with(_vars) { return ${s} }
    } catch(_error) {
      if (!(_error instanceof ReferenceError)) console.warn(_error);
      return "";
    }`)}catch(s){return console.warn('WHILE PARSING: ',t,'\n',s),function(){return''}}}function makeTemplate(e,t,s,n=s){if(0>s[t].indexOf('${'))return;let i=parse(s[t]);e.watch(()=>{n[t]=i(e)}),n[t]=i(e)}function bindObservable(e,t,s=!0){for(let n of e.attributes){let s=n.name.match(/^x-/)?document.createAttribute(n.name.replace(/^x-/,'')):n;makeTemplate(t,'value',n,s),s!==n&&e._el.setAttributeNode(s)}if(e.children.length)for(let n of e.childNodes)'TEXT'===n.tagName?makeTemplate(t,'text',n):s&&bindObservable(n,t);else e.html.trim()&&makeTemplate(t,'html',e)}function $(e,t=null){if(!e)return null;const s=t?t._el:document.documentElement,n='string'==typeof e?s.querySelector(e):e;if(!n)return null;if(n.$el)return n.$el;if(isOneOf$1(n,window,document.body,document.documentElement))return new WindowElement(n);const i=(n.tagName||'').toLowerCase();return 0<=svgTags.indexOf(i)?new SVGElement(n):0<=formTags.indexOf(i)?new FormElement(n):'canvas'===i?new CanvasElement(n):new Element(n)}function $$(e,t=null){const s=t?t._el:document.documentElement;let n=s.querySelectorAll(e||null);return Array.from(n,(e)=>$(e))}function $N(e,s={},n=null){const i=0>svgTags.indexOf(e)?document.createElement(e):document.createElementNS('http://www.w3.org/2000/svg',e);for(let t of Object.keys(s))'id'===t?i.id=s.id:'html'===t?i.innerHTML=s.html:'text'===t?i.textContent=s.text:i.setAttribute(t,s[t]);let t=$(i);return n&&n.append(t),t}function $$N(e){return $N('div',{html:e}).children}function toQueryString(e){let t=[];for(let s in e){let n=e[s];if(s=encodeURIComponent(s),null==n)return void t.push(s);n=Array.isArray(n)?n.join(','):''+n,n=n.replace(/(\r)?\n/g,'\r\n'),n=encodeURIComponent(n),n=n.replace(/%20/g,'+'),t.push(s+'='+n)}return t.join('&')}function fetch(e,t,s=null,n={async:!0,cache:!0}){let i=new XMLHttpRequest,a=defer$1(),r='';return i.onreadystatechange=function(){if(!(3>=i.readyState)){let e=i.status;200<=e&&300>e||304===e?a.resolve(i.responseText):a.reject(i)}},'GET'===e?(t+=0<=t.indexOf('?')?'&xhr=1':'?xhr=1',!n.cache&&(t+='_cachebust='+Date.now()),s&&(t+=toQueryString(s)+'&'),i.open(e,t,n.async,n.user,n.password)):'POST'==e&&(i.open(e,t,n.async,n.user,n.password),i.setRequestHeader('Content-Type','application/x-www-form-urlencoded'),i.setRequestHeader('X-CSRF-Token',window.csrfToken||''),r=isString$1(s)?'?'+s:Object.keys(s).map((e)=>encodeURIComponent(e)+'='+encodeURIComponent(s[e])).join('&')),i.setRequestHeader('x-requested-with','XMLHttpRequest'),i.send(r),a.promise}function get(e,t=null){return fetch('GET',e,t)}function post(e,t=null){return fetch('POST',e,t)}function sendLogs(){if(!1!==navigator.onLine){for(let e of Object.keys(POST_DATA))beacon(e,{data:JSON.stringify(POST_DATA[e])});POST_DATA={}}}function deferredPost(e,t){deepExtend$1(POST_DATA,{[e]:t}),doDeferredPost()}function beacon(e,t=null){fetch('POST',e,t)}function pad2(e){return 1===e.length?'0'+e:e}function interpolate(e,t,s){return s=clamp$1(s,0,1),e instanceof Colour||(e=Colour.fromHex(e)),t instanceof Colour||(t=Colour.fromHex(t)),new Colour(s*e.r+(1-s)*t.r,s*e.g+(1-s)*t.g,s*e.b+(1-s)*t.b,s*e.a+(1-s)*t.a)}function getColourAt(e,t){t=clamp$1(t,0,.9999);let s=_Mathfloor(t*(e.length-1)),n=t*(e.length-1)-s;return interpolate(e[s+1],e[s],n)}function applyTemplate(e,t){const s=Array.from(e.childNodes);if(t.template)e.innerHTML=t.template;else if(t.templateId){let s=document.querySelector(t.templateId);if(!s)throw new Error('Template not found:',t.templateId);for(;e.firstChild;)e.removeChild(e.firstChild);let n=document.importNode(s.content,!0);e.appendChild(n)}if(s.length){const t=e.querySelector('slot:not([name])');for(let n of s){let s=n.getAttribute?n.getAttribute('slot'):null,i=s?e.querySelector(`slot[name="${s}"]`):t;i&&i.parentNode.insertBefore(n,i)}for(let t of e.querySelectorAll('slot'))t.parentNode.removeChild(t)}}function customElementChildren(e){const t=[];for(let s of Array.from(e.children))s.tagName.startsWith('X-')?t.push(s):t.push(...customElementChildren(s));return t}function registerElement(e,t,s={}){class n extends CustomHTMLElement{constructor(){super(),this.$el=new t(this),this._wasConnected=!1}static get observedAttributes(){return s.attributes||[]}}customElementOptions.set(e.toUpperCase(),s),window.customElements.define(e,n)}function getOrigin(e){const t=0<e.xMin?e.xMin:0>e.xMax?e.xMax:0,s=0<e.yMin?e.yMin:0>e.yMax?e.yMax:0;return new Point(t,s)}function defaultSteps(e,t,s){const n=(t-e)/s,i=_Mathfloor(_Mathlog(n)),a=_Mathpow(10,i),r=GRID_STEPS.find((e)=>a*e<=n)*a;return t=r*_Mathceil(t/r),e=r*_Mathfloor(e/r),[e,t,r]}function computeAxis(e,t,s){let n=e[0],i=e[1],a=e[2];if(n=n?+n:s[0],i=i?+i:s[1],0<n&&(n=0),0>i&&(i=0),nearlyEquals(n,i))return[n-2,i+2,1];if(e[1]||(i+=.01*(i-n)),a)return[n,i,+a];const r=_Mathfloor(_Mathabs(t)/GRID_SPACING);return defaultSteps(n,i,r)}function getDataBounds(e){const t=_Mathmin(...e.map((e)=>_Mathmin(...e.map((e)=>e.y)))),s=_Mathmax(...e.map((e)=>_Mathmax(...e.map((e)=>e.y))));return[t,s]}function goLeft(e){const t=e.prev;t&&isOneOf$1(t.tagName,'MO','MI','MN')?t.insertBefore(e):t?last$1(t.children).append(e):!e.parent.hasClass('math')&&(e.parent.prev?e.parent.prev.append(e):e.parent.parent.insertBefore(e))}function goRight(e){const t=e.next;return t&&isOneOf$1(t.tagName,'MO','MI','MN')?t.insertAfter(e):void(t?t.children[0].prepend(e):e.parent.hasClass('math')||(e.parent.next?e.parent.next.prepend(e):e.parent.parent.insertAfter(e)))}function goUp(e){let t=e.parent;for(;'MFRAC'!==t.parent.tagName||!t.prev;){if(t.hasClass('math'))return;t=t.parent}t.prev.append(e)}function goDown(e){let t=e.parent;for(;'MFRAC'!==t.parent.tagName||!t.next;){if(t.hasClass('math'))return;t=t.parent}t.next.prepend(e)}function backspace(e){const t=e.prev,s=e.parent;if(t&&isOneOf$1(t.tagName,'MO','MI','MN'))t.remove(),1>=s.children.length&&s.addClass('empty');else if(!t&&!s.prev&&!e.parent.hasClass('math')){const t=s.parent;t.insertBefore(e);for(let e of t.children)for(let s of e.children)t.insertBefore(s);t.remove(),1>=e.parent.children.length&&e.parent.addClass('empty')}else goLeft(e)}function insertText(e,t){t.insertBefore(e),t.parent.removeClass('empty'),e.children.length&&e.children[0].append(t)}function type(e,t){'abcdefghijklmnopqrstuvwxyz'.includes(t)?insertText($N('mi',{text:t}),e):'0123456789.'.includes(t)?insertText($N('mn',{text:t}),e):'+\u2013\xB1\xD7\xF7<>\u2264\u2265=%!'.includes(t)?insertText($N('mo',{text:t,value:t}),e):'frac'===t?insertText($N('mfrac',{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),e):'sqrt'===t?insertText($N('msqrt',{html:'<mrow class="empty"></mrow>'}),e):isOneOf$1(t,'^','sup')?insertText($N('msup',{html:'<mrow class="empty"></mrow>'}),e):'brackets'===t||'([{|'.includes(t)?insertText($N('mfenced',{html:'<mrow class="empty"></mrow>',type:'('}),e):')]}'.includes(t)&&!e.next&&'MFENCED'===e.parent.parent.tagName&&e.parent.parent.insertAfter(e)}function toString$1(e){if(e.hasClass('cursor'))return'';if('TEXT'===e.tagName)return e.text;const t=e.childNodes;return'MFENCED'===e.tagName?'('+toString$1(t[0])+')':'MSUP'===e.tagName?'^('+toString$1(t[0])+')':'MFRAC'===e.tagName?toString$1(t[0])+'/'+toString$1(t[1]):'MSQRT'===e.tagName?'sqrt('+toString$1(t[0])+')':t.map((e)=>toString$1(e)).join('')}function parseInput(e){if(e.$('.empty'))return{error:'Fill in all empty placeholders in the expression.'};const t=toString$1(e);if(!t.trim())return{error:''};try{return{expr:new Expression(t)}}catch(e){return{error:'This is not a valid mathematical expression.'}}}function checkVariables(e,t,s){const n=e.variables.filter((e)=>!t.includes(e));if(t.length&&n.length){const e=autocorrect$1(n[0],t);return e?`Did you mean “<em>${e}</em>” instead of “<em>${n[0]}</em>”?`:`There shouldn’t be a variable called “<em>${n[0]}</em>”.`}const i=e.functions.filter((e)=>!s.includes(e));if(s.length&&i.length)return`This expression should not contain ${FN_NAMES[i[0]]}.`}function drawArc(e,t,s,n=!0){const i=t.x*(s.y-e.y)+e.x*(t.y-s.y)+s.x*(e.y-t.y),a=n&&0<i?1:0,r=n||0>i?1:0,o=Point.distance(t,e);return[e.x,e.y+'A'+o,o,0,a,r,s.x,s.y].join(',')}function angleSize(e,t){if(t.hasAttr('size'))return+t.attr('size');let s=40*(1-e.size/_MathPI/3);return e.isRight&&(s*=.6),s}function drawAngle(e,t){let s=e.a;const n=e.b;let i=e.c;const a=t.hasClass('fill'),r=t.hasAttr('sweep'),o=angleSize(e,t),l=Point.difference(s,n).normal,c=Point.difference(i,n).normal;s=Point.sum(n,l.scale(o)),i=Point.sum(n,c.scale(o));let h=a?`M${n.x},${n.y}L`:'M';if(e.isRight){const e=Point.sum(s,c.scale(o));h+=`${s.x},${s.y}L${e.x},${e.y}L${i.x},${i.y}`}else h+=drawArc(s,n,i,r);return a&&(h+='Z'),h}function drawPath(...e){return'M'+e.map((e)=>e.x+','+e.y).join('L')}function drawLineMark(e,t){const s=e.perpendicularVector.scale(6),i=e.normalVector.scale(3),n=e.midpoint;return'bar'===t?drawPath(n.add(s),n.add(s.inverse)):'bar2'===t?drawPath(n.add(i).add(s),n.add(i).add(s.inverse))+drawPath(n.add(i.inverse).add(s),n.add(i.inverse).add(s.inverse)):'arrow'===t?drawPath(n.add(i.inverse).add(s),n.add(i),n.add(i.inverse).add(s.inverse)):'arrow2'===t?drawPath(n.add(i.scale(-2)).add(s),n,n.add(i.scale(-2)).add(s.inverse))+drawPath(n.add(s),n.add(i.scale(2)),n.add(s.inverse)):void 0}function draw(e,t,s){if(e instanceof Angle)return drawAngle(e,t);if(e instanceof Segment){if(e.p1.equals(e.p2))return'';let s=drawPath(e.p1,e.p2);return t&&t.hasAttr('mark')&&(s+=drawLineMark(e,t.attr('mark'))),s}if(e instanceof Ray){const t=intersections(e,s.box)[0];return t?drawPath(e.p1,t):''}if(e instanceof Line){const n=intersections(e,s.box);if(2>n.length)return'';let i=drawPath(n[0],n[1]);return t&&t.hasAttr('mark')&&(i+=drawLineMark(e,t.attr('mark'))),i}return e instanceof Circle?`M ${e.c.x-e.r},${e.c.y} a ${e.r},${e.r} 0 1,0 ${2*e.r},0 a ${e.r},${e.r} 0 1,0 ${-2*e.r},0`:e instanceof Arc?'M'+drawArc(e.start,e.c,e.end):e instanceof Polyline?drawPath(...e.points):e instanceof Polygon?drawPath(...e.points)+'Z':e instanceof Rectangle?`M${e.p.x},${e.p.y}L${e.p.x+e.w},${e.p.y}L${e.p.x+e.w},${e.p.y+e.h}L${e.p.x},${e.p.y+e.h}Z`:void 0}function makeLabel(e,t,s){const n=e.hasClass('fill')||e.hasClass('move'),i=s||e.attr('label-colour');return $N('text',{target:e.attr('target')||'',class:e.attr('class')||'',fill:i||e.css(n?'fill':'stroke')},t.$labels)}function labelOverlap(e,t,s,n){let i=new Rectangle(new Point(-10,-20),20,23).rotate(s),r=t.paths.filter((t)=>t.val&&t.val!==e);for(let o of n)if(r.every((e)=>!intersections(i.translate(o),e.val).length))return o;return n[0]}function labelPosn(e,t,s){if(e instanceof Line){let n=e.perpendicularVector,i=e.angle;0<=n.y&&(n=n.scale(-1),i+=_MathPI);let a=[];for(let t of[.5,.35,.65])for(let s of[-15,5])a.push(e.at(t).add(n.scale(s)));let r=labelOverlap(e,s,i,a);return t.hasAttr('mark')&&(r=r.add(e.normalVector.scale(12))),`translate(${r.x}px, ${r.y}px) rotate(${i}rad)`}if(e instanceof Angle){const s=angleSize(e,t)+8,n=e.b.add(e.bisector.normalVector.scale(s+5));return`translate(${n.x}px, ${n.y+3}px)`}if(e instanceof Point){const n=t.hasClass('move')?10:8;let i=[e.shift(n,-n),e.shift(-n,-n),e.shift(n,10+n),e.shift(-n,10+n)],a=labelOverlap(e,s,0,i);return`translate(${a.x}px, ${a.y}px)`}if(e instanceof Polygon){const t=e.centroid;return`translate(${t.x}px, ${t.y+5}px)`}return e instanceof Circle?`translate(${e.c.x}px, ${e.c.y+5}px)`:''}function getToolTransform(e,t,s,n){return`translate(${e.x}px, ${e.y-t}px) scale(${n/100}) rotate(${s}rad)`}function openLightbox(e,t,n){isOpen=!0,$activeImg=e,$lightbox.show(),$lightboxImg.show();let i=e.bounds,a=$lightboxImg.bounds,r=i.left+i.width/2-a.left-a.width/2,o=i.top+i.height/2-a.top-a.height/2,l=_Mathmax(i.width/a.width,i.height/a.height);transform={x:r,y:o,s:l},$lightboxImg.css('background-image',`url(${n}), url(${t})`),$lightboxImg.transform=`translate(${r}px, ${o}px) scale(${l})`,Browser.redraw(),$lightboxImg.addClass('transitions'),Browser.redraw(),e.css('visibility','hidden'),$lightbox.addClass('on'),$lightboxImg.transform='scale(1) translate(0,0)'}function closeLightbox(){isOpen&&(isOpen=!1,$lightbox.removeClass('on'),$lightboxImg.transform=`translate(${transform.x}px, ${transform.y}px) scale(${transform.s})`,setTimeout(function(){$activeImg.css('visibility','visible'),$lightbox.css('display','none'),$lightboxImg.transform='none',$lightboxImg.removeClass('transitions')},400))}function getProgress(e){return`M${e},${e/2}a${e/2},${e/2},0,0,1,0,${e}A${e/2},${e/2},0,0,1,${e},${e/2}`}function getCheck(e){return`M ${e},0 C ${e/2},0,0,${e/2},0,${e}  s ${e/2},${e},${e},${e} `+`s ${e}-${e/2},${e}-${e}     S ${1.5*e},0,${e},0 z `+`M ${44.6*e/50},${76.1*e/50} L ${19.2*e/50},${48.8*e/50} `+`l ${4*e/50}-${4.2*e/50}     l ${19.8*e/50},${11.9*e/50} `+`l ${34.2*e/50}-${32.6*e/50} l ${3.5*e/50},${3.5*e/50} `+`L ${44.6*e/50},${76.1*e/50} z`}function confetti(e=2e3,t=150){$confetti||($confetti=$N('canvas',{style},$body)),$confetti.setAttr('width',Browser.width),$confetti.setAttr('height',Browser.height),$confetti.show();const s=$confetti.getContext(),n=tabulate$1((e)=>new Particle(e),t);let i=animate((a)=>{s.clearRect(0,0,Browser.width,Browser.height);let t=0;for(let i of n)i.draw(s),i.update(a,a<e),i.y<Browser.height&&(t+=1);t||(i.cancel(),$confetti.hide())})}function connect(e,t,s,n){let i=new Point(e.left-15,e.top+s-15),a=new Rectangle(i,e.width+30,e.height+30),r=a.project({x:t.left+t.width/2,y:t.top+t.height/2+n}),o=new Point(t.left-15,t.top+n-15),l=new Rectangle(o,t.width+30,t.height+30),d=l.project({x:e.left+e.width/2,y:e.top+e.height/2+s});return[r,d]}function distance(e,t){return _Mathabs(e[0]-t[0])+_Mathabs(e[1]-t[1])}function parseEmoji(e){return e.replace(/:(\w+):/g,function(e,t){return`<img class="emoji" width=20 height=20 src="/images/emoji/${t}.png"/>`})}function createMsgElement(e,t,{className:s,visible:n}={}){const i=$N('div',{class:'msg-wrap',"data-display":'flex'}),a=$N('div',{class:'msg '+t},i);return s&&a.addClass(s),n||i.hide(),isOneOf$1(t,'hint','question')?a.html=e:'img'===t?a.css('background-image',`url(${e})`):'video'==t&&$N('iframe',{src:e,allowfullscreen:!0},a),i}function formatTime(e){const t=_Mathfloor(+e/60),n=_Mathfloor(+e%60);return t+':'+(10>n?'0':'')+n}function tryClose(){$openModal&&$openModal.canClose&&$openModal.close()}function getOrCreateMethodChain(e,t){let s=instances.filter((s)=>s.context==e&&s.methodName==t)[0];return s||(s=new MethodChain(e,t),instances.push(s)),s}function createFieldsObj(e,t,s=void 0,n=void 0,i=void 0,a=void 0){if('function'==typeof n){const r=s.get('buildHitTask');return{buildHitTask:(s)=>{s.set(e,null,!0),s.set(t,null,!0),n(s,i,a),r(s)}}}return assign({},e,t)}function deferUntilPluginsLoaded(e,t){const s=e.get('trackingId'),n=queueMap[s]=queueMap[s]||{},i=()=>{clearTimeout(n.timeout),n.send&&MethodChain.remove(e,'send',n.send),delete queueMap[s],n.queue.forEach((e)=>e())};clearTimeout(n.timeout),n.timeout=setTimeout(i,0),n.queue=n.queue||[],n.queue.push(t),n.send||(n.send=(e)=>(...t)=>{i(),e(...t)},MethodChain.add(e,'send',n.send))}function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function isObject$2(e){return'object'==typeof e&&null!==e}function now(){return+new Date}function provide(e,t){const s=window.GoogleAnalyticsObject||'ga';window[s]=window[s]||function(...e){(window[s].q=window[s].q||[]).push(e)},window.gaDevIds=window.gaDevIds||[],0>window.gaDevIds.indexOf(DEV_ID)&&window.gaDevIds.push(DEV_ID),window[s]('provide',e,t),window.gaplugins=window.gaplugins||{},window.gaplugins[capitalize(e)]=t}function initStorageListener(){window.addEventListener('storage',storageListener),isListening=!0}function removeStorageListener(){window.removeEventListener('storage',storageListener),isListening=!1}function storageListener(e){const t=instances$1[e.key];if(t){const s=assign({},t.defaults_,parse$1(e.oldValue)),n=assign({},t.defaults_,parse$1(e.newValue));t.cache_=n,t.emit('externalSet',n,s)}}function parse$1(e){let t={};if(e)try{t=JSON.parse(e)}catch(e){}return t}function trackUsage(e,t){trackVersion(e),trackPlugin(e,t)}function convertHexToBin(e){return parseInt(e||'0',16).toString(2)}function convertBinToHex(e){return parseInt(e||'0',2).toString(16)}function padZeros(e,t){if(e.length<t)for(let s=t-e.length;s;)e='0'+e,s--;return e}function flipBitOn(e,t){return e.substr(0,t)+1+e.substr(t+1)}function trackPlugin(e,t){const s=e.get('&'+USAGE_PARAM);let n=padZeros(convertHexToBin(s),PLUGIN_COUNT);n=flipBitOn(n,PLUGIN_COUNT-t),e.set('&'+USAGE_PARAM,convertBinToHex(n))}function trackVersion(e){e.set('&'+VERSION_PARAM,VERSION)}var _Mathceil=Math.ceil,_Mathatan=Math.atan2,_Mathsin=Math.sin,_Mathcos=Math.cos,_Mathsqrt=Math.sqrt,_MathPI=Math.PI,_Mathlog2=Math.log,_Mathmin=Math.min,_Mathmax=Math.max,_Mathround=Math.round,_Mathpow=Math.pow,_Mathlog=Math.log10,_Mathfloor=Math.floor,_Mathabs=Math.abs;const tolerance=1e-6,NUM_REGEX=/(\d+)(\d{3})/,POWER_SUFFIX=['','k','m','b','t','q'],ONES=['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'],TENS=['','','twenty','thirty','fourty','fifty','sixty','seventy','eighty','ninety'],MULTIPLIERS=['','thousand','million','billion','trillion','quadrillion','quintillion','sextillion'];class ExprError extends Error{constructor(e,t){super(t),this.name=e}}let HAS_GENERATED_RULES=!1,REWRITE_RULES=[['x^0','1'],['0*x','0'],['x/x','1'],['x^1','x'],['x-(-y)','x+y'],['sqrt(x)','x^0.5'],['x-y','x+(-y)'],['-V','(-1) * V'],['x/(y^z)','x*(y^(-z))'],['x/y','x*(y^(-1))'],['(x*y)^z','x^z*y^z'],['a^(b+c)','a^b*a^c'],['(a^b)^c','a^(b*c)'],['log(a^b)','b*log(a)'],['log(a*b)','log(a)+log(b)'],['(a+b)^2','a^2+2*a*b+b^2'],['(a+b)*(c+d)','a*c+a*d+b*c+b*d'],['(a+b)*c','a*c+b*c'],['x * x','x^2'],['x * x^y','x^(y+1)'],['x^y * x^z','x^(y+z)'],['x+x','2*x'],['x+(-x)','0'],['x*y + x','x*(y+1)'],['x*y + x*z','x*(y+z)'],['(-1) * x','-x'],['x+(-y)','x-y'],['x*(y^(-1))','x/y'],['x*(y^(-z))','x/(y^z)'],['x^(-1)','1/x'],['x^0.5','sqrt(x)'],['x*(y/z)','(x*y)/z'],['x-(y+z)','x-y-z'],['1*x','x'],['0+x','x']];const FN_EVALUATE={"+":(...e)=>e.reduce((e,t)=>e+t,0),"-":(e,t)=>void 0===t?-e:e-t,"*":(...e)=>e.reduce((e,t)=>e*t,1),"/":(e,t)=>e/t,"!":(e)=>factorial(e),"%":(e)=>e/100,"^":(e,t)=>_Mathpow(e,t),log:(e,t)=>void 0===t?_Mathlog2(e):_Mathlog2(e)/_Mathlog2(t),"=":(e,t)=>0==simplify(['-',e,t])},CONSTANTS={pi:_MathPI,e:Math.E},FN_STRINGIFY={"+":(...e)=>e.join(' + '),"-":(e,t)=>void 0===t?'-'+e:e+' - '+t,"±":(e,t)=>void 0===t?'\xB1'+e:e+' \xB1 '+t,"*":(...e)=>e.join('*'),"/":(e,t)=>e+'/'+t,"!":(e)=>e+'!',"%":(e)=>e+'%',abs:(e)=>'|'+e+'|',"^":(e,t)=>e+'^'+t,"=":(e,t)=>e+' = '+t,"<":(e,t)=>e+' < '+t,">":(e,t)=>e+' > '+t,"≤":(e,t)=>e+' \u2264 '+t,"≥":(e,t)=>e+' \u2265 '+t},PRECEDENCE=['+','-','*','/','sqrt','^'],TOKEN_REGEX=/\b[0-9]+(\.[0-9]*)?\b|\b\.[0-9]+\b|\b\w+\b|\+|-|–|±|\*|×|\/|÷|\^|%|!|\(|\)|\[|]|{|}|\||=|<|>|≤|≥/g,TOKEN_REPLACE={"–":'-',"÷":'/',"×":'*'},BRACKETS={"(":')',"[":']',"{":'}',"|":'|'};class Expression{constructor(e){this.expr=isString(e)?parseString(e):e}toString(){return stringify(this.expr)}get simplified(){return new Expression(simplify(this.expr))}get functions(){return functions(this.expr)}get variables(){return variables(this.expr)}get mathML(){return mathML(this.expr)}same(e){return same(this.expr,e.expr)}equals(e){return 0===simplify(['-',this.expr,e.expr])}evaluate(e={}){let t=evaluate(this.expr,e);if(!isNumber(t)){let e=[...variables(t),...functions(t)].join(', ');throw new ExprError('EvalError',`This expression contains unknown variables or functions: ${e}.`)}return t}numEquals(e){let t=this.variables;if(difference(t,e.variables).length)return!1;for(let s,n=0;5>n;++n){s={};for(let e of t)s[e]=5*Math.random();let n=evaluate(substitute(this.expr,s)),i=evaluate(substitute(e.expr,s));if(!nearlyEquals(n,i))return!1}return!0}substitute(e){let t={};for(let s of Object.keys(e))t[s]=parseString(''+e[s]);return new Expression(substitute(this.expr,t))}}class Point{constructor(e=0,t=0){this.x=e,this.y=t}get normal(){return this.scale(1/this.length)}get length(){return _Mathsqrt(square(this.x)+square(this.y))}get inverse(){return new Point(-this.x,-this.y)}get flip(){return new Point(this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(e){return Point.distance(this,e.project(this))}clamp(e,t,s,n){return new Point(clamp(this.x,e,t),clamp(this.y,s,n))}transform(e){if(!e)return this;let t=e[0][0]*this.x+e[0][1]*this.y+e[0][2],s=e[1][0]*this.x+e[1][1]*this.y+e[1][2];return new Point(t,s)}rotate(e,t=origin){let s=this.x-t.x,n=this.y-t.y,i=_Mathcos(e),a=_Mathsin(e),r=s*i-n*a+t.x,o=s*a+n*i+t.y;return new Point(r,o)}reflect(e){let t=e.p2.x-e.p1.x,s=e.p2.y-e.p1.y,n=this.x-e.p1.x,i=this.y-e.p1.y,a=(t*i-s*n)/(t*t+s*s),r=this.x+2*a*s,o=this.y-2*a*t;return new Point(r,o)}scale(e,t=e){return new Point(this.x*e,this.y*t)}shift(e,t=e){return new Point(this.x+e,this.y+t)}translate(e){return this.shift(e.x,e.y)}changeCoordinates(e,t){const s=t.xMin+(this.x-e.xMin)/e.dx*t.dx,n=t.yMin+(this.y-e.yMin)/e.dy*t.dy;return new Point(s,n)}add(e){return Point.sum(this,e)}subtract(e){return Point.difference(this,e)}equals(e){return Point.equals(this,e)}round(e=1){return new Point(roundTo(this.x,e),roundTo(this.y,e))}mod(e,t=e){return new Point(this.x%e,this.y%t)}static average(...e){let t=total(e.map((e)=>e.x))/e.length,s=total(e.map((e)=>e.y))/e.length;return new Point(t,s)}static dot(e,t){return e.x*t.x+e.y*t.y}static sum(e,t){return new Point(e.x+t.x,e.y+t.y)}static difference(e,t){return new Point(e.x-t.x,e.y-t.y)}static distance(e,t){return _Mathsqrt(square(e.x-t.x)+square(e.y-t.y))}static manhattan(e,t){return _Mathabs(e.x-t.x)+_Mathabs(e.y-t.y)}static interpolate(e,s,n=.5){return new Point(e.x+n*(s.x-e.x),e.y+n*(s.y-e.y))}static equals(e,t){return nearlyEquals(e.x,t.x)&&nearlyEquals(e.y,t.y)}}const origin=new Point(0,0);class Bounds{constructor(e,t,s,n){this.xMin=e,this.xMax=t,this.yMin=s,this.yMax=n}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}}const twoPi=2*_MathPI;class Angle{constructor(e,t,s){this.a=e,this.b=t,this.c=s}transform(e){return e?new Angle(this.a.transform(e),this.b.transform(e),this.c.transform(e)):this}get rad(){let e=_Mathatan(this.a.y-this.b.y,this.a.x-this.b.x),t=_Mathatan(this.c.y-this.b.y,this.c.x-this.b.x),s=t-e;return 0>s&&(s+=2*_MathPI),s}get deg(){return 180*this.rad/_MathPI}get size(){let e=this.rad;return _Mathmin(e,2*_MathPI-e)}get isRight(){return nearlyEquals(this.size,_MathPI/2,.01)}get bisector(){let e=_Mathatan(this.a.y-this.b.y,this.a.x-this.b.x),t=_Mathatan(this.c.y-this.b.y,this.c.x-this.b.x),s=(e+t)/2;e>t&&(s+=_MathPI);let n=_Mathcos(s)+this.b.x,i=_Mathsin(s)+this.b.y;return new Line(this.b,new Point(n,i))}}class Line{constructor(e,t){this.p1=e,this.p2=t}get length(){return Point.distance(this.p1,this.p2)}get midpoint(){return Point.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y+this.slope*this.p1.x}get angle(){return rad(this.p2,this.p1)}get normalVector(){let e=this.length,t=(this.p2.x-this.p1.x)/e,s=(this.p2.y-this.p1.y)/e;return new Point(t,s)}get perpendicularVector(){return new Point(this.p2.y-this.p1.y,this.p1.x-this.p2.x).normal}get perpBisector(){return this.perpendicular(this.midpoint)}parallel(e){const t=Point.sum(e,Point.difference(this.p2,this.p1));return new Line(e,t)}perpendicular(e){return new Line(e,Point.sum(e,this.perpendicularVector))}contains(e){const t=e.x*(this.p1.y-this.p2.y)+this.p1.x*(this.p2.y-e.y)+this.p2.x*(e.y-this.p1.y);return nearlyEquals(t,0)}at(e){return Point.interpolate(this.p1,this.p2,e)}project(e){const t=Point.difference(this.p2,this.p1),s=Point.difference(e,this.p1),n=t.scale(Point.dot(t,s)/square(this.length));return Point.sum(this.p1,n)}transform(e){return e?new this.constructor(this.p1.transform(e),this.p2.transform(e)):this}rotate(e,t=origin){return new this.constructor(this.p1.rotate(e,t),this.p2.rotate(e,t))}reflect(e){return new this.constructor(this.p1.reflect(e),this.p2.reflect(e))}scale(e,t=e){return new this.constructor(this.p1.scale(e,t),this.p2.scale(e,t))}shift(e,t=e){return new this.constructor(this.p1.shift(e,t),this.p2.shift(e,t))}translate(e){return new this.constructor(this.p1.translate(e),this.p2.translate(e))}equals(e){return this.constructor.equals(this,e)}static equals(e,t){return e.contains(t.p1)&&e.contains(t.p2)}}class Ray extends Line{}class Segment extends Line{contains(){}project(e){const t=Point.difference(this.p2,this.p1),s=Point.difference(e,this.p1),n=clamp(Point.dot(t,s)/square(this.length),0,1);return Point.sum(this.p1,t.scale(n))}static equals(e,t,s=!1){return Point.equals(e.p1,t.p1)&&Point.equals(e.p2,t.p2)||!s&&Point.equals(e.p1,t.p2)&&Point.equals(e.p2,t.p1)}static intersect(e,t){const s=new Segment(e.p1,e.p2),n=new Segment(t.p1,t.p2);return intersections(s,n)[0]||null}}class Circle{constructor(e=origin,t=1){this.c=e,this.r=t}get circumference(){return 2*_MathPI*this.r}get area(){return _MathPI*square(this.r)}get arc(){let e=this.c.shift(this.r,0);return new Arc(this.c,e,twoPi)}transform(e){return e?new Circle(this.c.transform(e),this.r*(e[0][0]+e[1][1])/2):this}rotate(e,t=origin){return new Circle(this.c.rotate(e,t),this.r)}reflect(e){return new Circle(this.c.reflect(e),this.r)}scale(e,t=e){return new Circle(this.c.scale(e,t),this.r*(e+t)/2)}shift(e,t=e){return new Circle(this.c.shift(e,t),this.r)}translate(e){return new Circle(this.c.translate(e),this.r)}contains(e){return Point.distance(e,this.c)<=this.r}equals(e){return e instanceof Circle&&nearlyEquals(this.r,e.r)&&this.c.equals(e.c)}project(e){const t=Point.difference(e,this.c).normal.scale(this.r);return Point.sum(this.c,t)}at(e){const t=2*_MathPI*e;return this.c.shift(this.r*_Mathcos(t),this.r*_Mathsin(t))}}class Arc{constructor(e,t,s){this.c=e,this.start=t,this.angle=s}get radius(){return Point.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}transform(e){return e?new Arc(this.c.transform(e),this.start.transform(e),this.angle):this}get startAngle(){return rad(this.start,this.c)}project(e){let t=this.startAngle,s=t+this.angle,n=rad(e,this.c);return s>twoPi&&n<s-twoPi&&(n+=twoPi),n=clamp(n,t,s),this.c.shift(this.radius,0).rotate(n,this.c)}at(e){return this.start.rotate(this.angle*e,this.c)}contract(e){return new Arc(this.c,this.at(e/2),this.angle*(1-e))}}class Polygon{constructor(...e){this.points=e}get circumference(){let e=0;for(let t=1;t<this.points.length;++t)e+=Point.distance(this.points[t-1],this.points[t]);return e}get signedArea(){let e=this.points,t=e.length,s=e[t-1].x*e[0].y-e[0].x*e[t-1].y;for(let n=1;n<t;++n)s+=e[n-1].x*e[n].y-e[n].x*e[n-1].y;return s/2}get area(){return _Mathabs(this.signedArea)}get centroid(){let e=this.points,t=e.length,s=0;for(let n=0;n<t;++n)s+=e[n].x;let n=0;for(let s=0;s<t;++s)n+=e[s].y;return new Point(s/t,n/t)}get edges(){let e=this.points,t=e.length,s=[];for(let n=0;n<t;++n)s.push(new Segment(e[n],e[(n+1)%t]));return s}transform(e){return e?new this.constructor(...this.points.map((t)=>t.transform(e))):this}rotate(e,t=origin){const s=this.points.map((s)=>s.rotate(e,t));return new this.constructor(...s)}reflect(e){const t=this.points.map((t)=>t.reflect(e));return new this.constructor(...t)}scale(e,t=e){const s=this.points.map((s)=>s.scale(e,t));return new this.constructor(...s)}shift(e,t=e){const s=this.points.map((s)=>s.shift(e,t));return new this.constructor(...s)}translate(e){return this.shift(e.x,e.y)}contains(e){let t=this.points.length,s=!1;for(let n=0;n<t;++n){const i=this.points[n],a=this.points[(n+1)%t],r=i.y>e.y!=a.y>e.y,o=e.x<(a.x-i.x)*(e.y-i.y)/(a.y-i.y)+i.x;r&&o&&(s=!s)}return s}equals(){}project(){}at(){}get oriented(){if(0<=this.signedArea)return this;const e=[...this.points].reverse();return new Polygon(...e)}intersect(e){const t=[toLinkedList(this.oriented.points),toLinkedList(e.oriented.points)],s=this.points.length+e.points.length,n=[];let i=0,a=t[i].find((t)=>e.contains(t.val));if(!a)return null;for(;a.val!==n[0]&&n.length<s;){n.push(a.val);const e=new Segment(a.val,a.next.val);a=a.next;for(let s of t[1-i]){const t=new Segment(s.val,s.next.val),n=intersections(e,t)[0];if(n){i=1-i,a={val:n,next:s.next};break}}}return new Polygon(...n)}static collision(e,t){for(let s of e.edges)for(let e of t.edges)if(Segment.intersect(s,e))return!0;for(let s of e.points)if(t.contains(s))return!0;for(let s of t.points)if(e.contains(s))return!0;return!1}}class Polyline extends Polygon{get edges(){let e=[];for(let t=0;t<this.points.length-1;++t)e.push(new Segment(this.points[t],this.points[t+1]));return e}}class Triangle extends Polygon{constructor(e,t,s){super(e,t,s)}get circumcircle(){const e=this.points,t=2*(e[0].x*(e[1].y-e[2].y)+e[1].x*(e[2].y-e[0].y)+e[2].x*(e[0].y-e[1].y)),s=(square(e[0].x)+square(e[0].y))*(e[1].y-e[2].y)+(square(e[1].x)+square(e[1].y))*(e[2].y-e[0].y)+(square(e[2].x)+square(e[2].y))*(e[0].y-e[1].y),n=(square(e[0].x)+square(e[0].y))*(e[2].x-e[1].x)+(square(e[1].x)+square(e[1].y))*(e[0].x-e[2].x)+(square(e[2].x)+square(e[2].y))*(e[1].x-e[0].x),i=new Point(s/t,n/t),a=Point.distance(i,this.points[0]);return new Circle(i,a)}get incircle(){const e=this.edges,t=e.map((t)=>t.length),s=t[0]+t[1]+t[2],n=this.points,i=t[1]*n[0].x+t[2]*n[1].x+t[0]*n[2].x,a=t[1]*n[0].y+t[2]*n[1].y+t[0]*n[2].y,r=new Point(i/s,a/s),o=r.distanceFromLine(e[0]);return new Circle(r,o)}get orthocenter(){const e=this.points,t=e[0],s=e[1],n=e[2],i=new Line(t,s).perpendicular(n),a=new Line(t,n).perpendicular(s);return intersections(i,a)[0]}}class Rectangle{constructor(e,t=1,s=t){this.p=e,this.w=t,this.h=s}get center(){return new Point(this.p.x+this.w/2,this.p.y+this.h/2)}get circumference(){return 2*_Mathabs(this.w)+2*_Mathabs(this.h)}get area(){return _Mathabs(this.w*this.h)}get edges(){return this.polygon.edges}get polygon(){let e=new Point(this.p.x+this.w,this.p.y),t=new Point(this.p.x+this.w,this.p.y+this.h),s=new Point(this.p.x,this.p.y+this.h);return new Polygon(this.p,e,t,s)}transform(e){return e?this.polygon.transform(e):this}rotate(e,t=origin){return this.polygon.rotate(e,t)}reflect(e){return this.polygon.reflect(e)}scale(e,t=e){return new Rectangle(this.p.scale(e,t),this.w*e,this.h*t)}shift(e,t=e){return new Rectangle(this.p.shift(e,t),this.w,this.h)}translate(e){return new Rectangle(this.p.translate(e),this.w,this.h)}contains(){}equals(){}project(e){let t={x:this.p.x+this.w,y:this.p.y+this.h},s={x:this.p.x+this.w/2,y:this.p.y+this.h/2},n=(s.y-e.y)/(s.x-e.x);if(e.x<=s.x){let s=n*(this.p.x-e.x)+e.y;if(this.p.y<s&&s<t.y)return new Point(this.p.x,s)}if(e.x>=s.x){let s=n*(t.x-e.x)+e.y;if(this.p.y<s&&s<t.y)return new Point(t.x,s)}if(e.y<=s.y){let s=(this.p.y-e.y)/n+e.x;if(this.p.x<s&&s<t.x)return new Point(s,this.p.y)}if(e.y>=s.y){let s=(t.y-e.y)/n+e.x;if(this.p.x<s&&s<t.x)return new Point(s,t.y)}}at(){}}class Evented$1{constructor({split:e=' ',lowercase:t=!1}={}){this._options={split:e,lowercase:t},this._events={}}on(t,s){for(let n of process$1(t,this._options))n in this._events||(this._events[n]=[]),this._events[n].push(s)}one(e,t){function s(...i){n.off(e,s),t(...i)}let n=this;this.on(e,s)}off(t,e){for(let s of process$1(t,this._options))s in this._events&&(this._events[s]=this._events[s].filter((t)=>t!==e))}trigger(t,...e){for(let s of process$1(t,this._options))s in this._events&&this._events[s].forEach(function(t){t.apply(this,e)})}}let isReady=!1;setTimeout(function(){isReady=!0});const cssMatrix=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/,browserEvents=new Evented$1,ua=window.navigator.userAgent,mobileRegex=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;let width=window.innerWidth,height=window.innerHeight;window.onresize=throttle$1(function(){let e=window.innerWidth,t=window.innerHeight;width===e&&800>width&&800>t||(width=e,browserEvents.trigger('resize',{width,height:t}),$body.trigger('scroll',{top:$body.scrollTop}))},100);const doResize=throttle$1(function(){width=window.innerWidth,height=window.innerHeight,browserEvents.trigger('resize',{width,height})});let loadQueue=[],loaded=!1;window.onload=afterLoad,document.addEventListener('DOMContentLoaded',afterLoad);const STORAGE_KEY='_M',keyCodes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},IEUA=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,webkitUA=/\bAppleWebKit\/(\d+)\b/,EdgeUA=/\bEdge\/12\.(\d+)\b/,polyfill=IEUA.test(navigator.userAgent)||10547>(navigator.userAgent.match(EdgeUA)||[])[1]||537>(navigator.userAgent.match(webkitUA)||[])[1],requests={};let isOldWebkit=!('hidden'in document)&&'webkitHidden'in document,visibilityProperty=isOldWebkit?'webkitHidden':'hidden',visibilityEvent=isOldWebkit?'webkitvisibilitychange':'visibilitychange';document.addEventListener(visibilityEvent,function(){browserEvents.trigger(document[visibilityProperty]?'focus':'blur')});const Browser={isMobile:mobileRegex.test(navigator.userAgent.toLowerCase()),isRetina:1<(window.devicePixelRatio||1),isTouch:'ontouchstart'in window||window.DocumentTouch&&document instanceof window.DocumentTouch,isChrome:window.chrome,isIE:0<=ua.indexOf('MSIE')||0<=ua.indexOf('Trident'),isFirefox:0<=navigator.userAgent.search('Firefox'),redraw,ready,resize,cssTimeToNumber,addCSS,addCSSRule,replaceSvgImports,on:browserEvents.on.bind(browserEvents),off:browserEvents.off.bind(browserEvents),trigger:browserEvents.trigger.bind(browserEvents),get width(){return width},get height(){return height},get hash(){return window.location.hash.slice(1)},set hash(e){let t=document.body.scrollTop;window.location.hash=e,document.body.scrollTop=t},get cookies(){return getCookies()},getCookie,setCookie,deleteCookie,setStorage,getStorage,deleteStorage,get activeInput(){return activeInput()},keyCodes,onKey};let observer,touchEnabled=!1;document.addEventListener('touchstart',()=>touchEnabled=!0);const aliases={change:'propertychange keyup input paste',scrollwheel:'DOMMouseScroll mousewheel',pointerdown:'mousedown touchstart',pointermove:'mousemove touchmove',pointerup:'mouseup touchend',pointercancel:'touchcancel',pointerstop:'mouseup touchend touchcancel'},customEvents={scroll:makeScrollEvents,hover:makeHoverEvent,click:makeClickEvent,clickOutside:makeClickOutsideEvent,mousedown:makeMouseEvent.bind(null,'mousedown'),mousemove:makeMouseEvent.bind(null,'mousemove'),mouseup:makeMouseEvent.bind(null,'mouseup'),pointerenter:makePointerPositionEvents,pointerleave:makePointerPositionEvents,enterViewport:makeIntersectionEvents,exitViewport:makeIntersectionEvents},ALPHABETH='zyxwvutsrqponmlkjihgfedcba';class Element{constructor(e){this._el=e,this._data=e?e._m_data||(e._m_data={}):{},this._events=e?e._m_events||(e._m_events={}):{}}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el instanceof Text?'TEXT':this._el.tagName.toUpperCase()}getModel(){return this.parent?this.parent.model||this.parent.getModel():null}bindObservable(e,t=!0){return bindObservable(this,e,t),e}addClass(e){let t=words$1(e);if(this._el.classList)for(let e of t)this._el.classList.add(e);else this._el.className+=' '+e}removeClass(e){let t=words$1(e);if(this._el.classList)for(let e of t)this._el.classList.remove(e);else{let e=new RegExp('(^|\\s)'+t.join('|')+'(\\s|$)','gi');this._el.className=this._el.className.toString().replace(e,' ')}}hasClass(e){let t=this._el.className;return 0<=(' '+t+' ').indexOf(' '+e.trim()+' ')}toggleClass(e){this.hasClass(e)?this.removeClass(e):this.addClass(e)}setClass(e,t){t?this.addClass(e):this.removeClass(e)}attr(e){return this._el.getAttribute(e)||''}hasAttr(e){return this._el.hasAttribute(e)}setAttr(e,t){this._el.setAttribute(e,t)}removeAttr(e){this._el.removeAttribute(e)}get attributes(){return Array.from(this._el.attributes||[])}get value(){return this._el.value}set value(e){this._el.value=e}get html(){return this._el.innerHTML||''}set html(e){this._el.innerHTML=e}get text(){return this._el.textContent||''}set text(e){this._el.textContent=e}blur(){this._el.blur()}focus(){this._el.focus()}get bounds(){return this._el.getBoundingClientRect()}get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get clientPoint(){const e=this.bounds;return new Point(e.left,e.top)}get offsetParent(){let e=this._el.offsetParent;return e?$(e):null}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){const e=parseFloat(this.css('padding-left')),t=parseFloat(this.css('padding-right'));return this._el.clientWidth-e-t}get innerHeight(){const e=parseFloat(this.css('padding-bottom')),t=parseFloat(this.css('padding-top'));return this._el.clientHeight-e-t}get outerWidth(){const e=parseFloat(this.css('margin-left')),t=parseFloat(this.css('margin-right'));return this.width+e+t}get outerHeight(){const e=parseFloat(this.css('margin-bottom')),t=parseFloat(this.css('margin-top'));return this.height+e+t}get positionTop(){let e=this._el,t=0;do t+=e.offsetTop;while(e=e.offsetParent);return t}get positionLeft(){let e=this._el,t=0;do t+=e.offsetLeft;while(e=e.offsetParent);return t}get boxCenter(){let e=this.bounds;return new Point(e.left+e.width/2,e.top+e.height/2)}offset(e){if(e._el===this._el.offsetParent){let t=this.offsetTop+e._el.clientTop,s=this.offsetLeft+e._el.clientLeft,n=t+this.height,i=s+this.width;return{top:t,left:s,bottom:n,right:i}}else{let t=e._el.getBoundingClientRect(),s=this._el.getBoundingClientRect();return{top:s.top-t.top,left:s.left-t.left,bottom:s.bottom-t.top,right:s.right-t.left}}}get isInViewport(){if(0===this.height)return!1;const e=this.bounds;return isBetween(e.top,-e.height,Browser.height)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}get scrollLeft(){return this._el.scrollLeft}set scrollTop(e){this._el.scrollTop=e,this.trigger('scroll',{top:e,left:this.scrollLeft})}set scrollLeft(e){this._el.scrollLeft=e,this.trigger('scroll',{top:this.scrollTop,left:e})}fixOverflowScroll(){this._data._fixOverflowScroll||(this._data._fixOverflowScroll=!0,this._el.addEventListener('touchstart',()=>{const e=this.scrollTop,t=this.scrollHeight-this.height;0>=e&&(this.scrollTop=1),e>=t&&(this.scrollTop=t-1)}))}scrollTo(e,t=1e3,s='cubic'){0>e&&(e=0);const n=this.scrollTop,i=e-n;animate((e)=>{const t=n+i*ease(s,e);this.scrollTop=t,this.trigger('scroll',{top:t})},t)}scrollBy(e,t=1e3,s='cubic'){e&&this.scrollTo(this.scrollTop+e,t,s)}css(e,t){if(void 0!==t)this._el.style[toCamelCase$1(e)]=t;else if('string'==typeof e)return window.getComputedStyle(this._el).getPropertyValue(e);else{const t=Object.keys(e);for(let s of t)this._el.style[toCamelCase$1(s)]=e[s]}}get transition(){return this.css('transform')}set transition(e){this._el.style.transition=e}get transform(){return this.css('transform').replace('none','')}set transform(e){this._el.style.transform=e}get transformMatrix(){let e=this.css('transform');if(!e||'none'===e)return[[1,0,0],[0,1,0]];let t=e.match(/matrix\(([0-9\,\.\s\-]*)\)/);if(!t[1])return[[1,0,0],[0,1,0]];let s=t[1].split(',');return[[+s[0],+s[2],+s[4]],[+s[1],+s[3],+s[5]]]}get scale(){let e=this.transformMatrix;return[e[0][0],e[1][1]]}translate(e,t){e=roundTo(+e||0,.1),t=roundTo(+t||0,.1),this.transform=`translate(${e}px,${t}px)`}translateX(e){this.transform=`translate(${roundTo(+e||0,.1)}px,0)`}translateY(e){this.transform=`translate(0,${roundTo(+e||0,.1)}px)`}show(){this.hasAttr('hidden')&&this.removeAttr('hidden'),'visibility'===this.data.display?this._el.style.visibility='visible':this._el.style.display=this.data.display||'block'}hide(){'visibility'===this.data.display?this._el.style.visibility='hidden':this._el.style.display='none'}transitionEnd(e){this.one('transitionend',e)}animationEnd(e){this.one('animationend',e)}is(e){return this._el.matches?this._el.matches(e):-1<[].indexOf.call(document.querySelectorAll(e),this._el)}index(){let e=0,t=this._el;for(;null!==(t=t.previousSibling);)++e;return e}prepend(e){let t=this._el.childNodes;if('string'==typeof e){let t=$$N(e);for(let e=t.length-1;0<=e;--e)this._el.insertBefore(t[e],this._el.childNodes[0])}else t.length?this._el.insertBefore(e._el,t[0]):this._el.appendChild(e._el)}append(e){if('string'==typeof e){let t=$$N(e);for(let e of t)this._el.appendChild(e._el)}else this._el.appendChild(e._el)}insertBefore(e){let t=this.parent;if('string'==typeof e){let s=$$N(e);for(let e=s.length-1;0<=e;--e)t._el.insertBefore(s[e]._el,this._el)}else t._el.insertBefore(e._el,this._el)}insertAfter(e){let t=this.parent;if('string'==typeof e){let s=$$N(e);for(let e of s)t._el.insertAfter(this._el,e._el)}else{let s=this._el.nextSibling;s?t._el.insertBefore(e._el,s):t._el.appendChild(e._el)}}wrap(e){return'string'==typeof e&&(e=$N(e)),this.insertBefore(e),this.detach(),e.append(this),e}moveTo(e,t=!1){t?e.prepend(this):e.append(this)}get next(){let e=this._el.nextSibling;return e?$(e):null}get prev(){let e=this._el.previousSibling;return e?$(e):null}$(e){return $(e,this)}$$(e){return $$(e,this)}get parent(){let e=this._el.parentElement;return e?$(e):null}get siblings(){let e=[],t=this._el.parentNode.firstChild;do e.push($(t));while(t=t.nextSibling);return e}parents(e){let t=[],s=this.parent;for(;s;)(!e||s.is(e))&&t.push(s),s=s.parent;return t}hasParent(...e){for(let t=e.map((e)=>e._el),s=this._el.parentNode;s;){if(isOneOf$1(s,...t))return!0;s=s.parentNode}return!1}get children(){let e=this._el.children||[];return Array.from(e,(e)=>$(e))}get childNodes(){let e=this._el.childNodes||[];return Array.from(e,(e)=>$(e))}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach(),this._el=null}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}replaceWith(...e){for(let t of e)this.insertBefore(t);this.remove()}on(t,s=null,n=!1){if(s)for(let i of words$1(t))createEvent(this,i,s,n);else for(let s of Object.keys(t))createEvent(this,s,t[s])}one(e,t,s=!1){const n=()=>{this.off(e,n,s),t(e,t,s)};this.on(e,n,s)}off(t,s,n=!1){for(let i of words$1(t))removeEvent(this,i,s,n)}trigger(t,s={}){for(let n of words$1(t)){if(!this._events[n])return;for(let e of this._events[n])e.call(this,s)}}onKeyDown(t,s){t=words$1(t).map((e)=>Browser.keyCodes[e]||e),this._el.addEventListener('keydown',function(n){0<=t.indexOf(n.keyCode)&&s(n)})}animate(e,t,s,n){return transition(this,e,t,s,n)}enter(...e){return enter(this,...e)}exit(...e){return exit(this,...e)}effect(e){effect(this,e)}fadeIn(e=400){return enter(this,'fade',e)}fadeOut(e=400){return exit(this,'fade',e)}get cursor(){let e=window.getSelection();if(!e.rangeCount)return[0,0];let t=window.getSelection().getRangeAt(0),s=t.cloneRange();s.selectNodeContents(this._el),s.setEnd(t.startContainer,t.startOffset);let n=s.toString().length;s.setEnd(t.endContainer,t.endOffset);let i=s.toString().length;return[n,i]}}class WindowElement extends Element{get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}get scrollLeft(){return window.pageXOffset}set scrollTop(e){document.body.scrollTop=document.documentElement.scrollTop=e,this.trigger('scroll',{top:e,left:this.scrollLeft})}set scrollLeft(e){document.body.scrollLeft=document.documentElement.scrollLeft=e,this.trigger('scroll',{top:this.scrollTop,left:e})}}class FormElement extends Element{get action(){return this._el.action}get checked(){return this._el.checked}get formData(){const e={};for(let t of Array.from(this._el.elements)){const s=t.name||t.id;s&&(e[s]=t.value)}return e}change(e){let t='';this.on('change',()=>{this.value===t||(t=this.value.trim(),e(t))})}validate(e){this.change((t)=>{this.setValidity(e(t))})}setValidity(e){this._el.setCustomValidity(e||'')}get isValid(){return this._el.checkValidity()}}class SVGElement extends Element{hasClass(e){let t=this._el.className.baseVal;return 0<=(' '+t+' ').indexOf(' '+e.trim()+' ')}get width(){return this.bounds.width}get height(){return this.bounds.height}get viewBox(){return this._el.viewBox.baseVal||{}}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get positionTop(){let e=this.parent;for(;e instanceof SVGElement;)e=e.parent;return e.positionTop+this._el.getBBox().y}get positionLeft(){let e=this.parent;for(;e instanceof SVGElement;)e=e.parent;return e.positionLeft+this._el.getBBox().x}get inverseTransformMatrix(){const e=this._el.getScreenCTM().inverse(),t=[[e.a,e.c,e.e],[e.b,e.d,e.f]];if(Browser.isFirefox){let e=this.transformMatrix;t[0][2]-=e[0][2],t[1][2]-=e[1][2]}return t}get strokeLength(){if('getTotalLength'in this._el)return this._el.getTotalLength();if(this._el instanceof SVGLineElement)return _Mathsqrt(square$1(this._el.x2.baseVal.value-this._el.x1.baseVal.value)+square$1(this._el.y2.baseVal.value-this._el.y1.baseVal.value));else{let e=this.bounds;return 2*e.height+2*e.width}}getPointAt(e){return this._el.getPointAtLength(e*this.strokeLength)}getPointAtLength(e){return this._el.getPointAtLength(e)}get points(){let e=this.attr('d');return e?e.replace(/[MZ]/g,'').split(/[LA]/).map((e)=>{let t=e.split(',');return{x:+t[t.length-2],y:+t[t.length-1]}}):[]}set points(e){let t=e.length?'M'+e.map((e)=>e.x+','+e.y).join('L'):'';this.setAttr('d',t)}addPoint(e){let t=this.attr('d')+' L '+e.x+','+e.y;this.setAttr('d',t)}get center(){return new Point(+this.attr('cx'),+this.attr('cy'))}setCenter(e){this.setAttr('cx',e.x),this.setAttr('cy',e.y)}setLine(e,t){this.setAttr('x1',e.x),this.setAttr('y1',e.y),this.setAttr('x2',t.x),this.setAttr('y2',t.y)}}class CanvasElement extends Element{getContext(e='2d',t={}){return this._el.getContext(e,t)}get pngImage(){return this._el.toDataURL('image/png')}}const svgTags=['path','rect','circle','ellipse','polygon','polyline','g','defs','marker','line','text','pattern','mask','svg'],formTags=['form','input','select'],$window=new WindowElement(window),$html=new WindowElement(window.document.documentElement),$body=new WindowElement(document.body);let POST_DATA={};const doDeferredPost=throttle$1(sendLogs,5e3);window.addEventListener('online',doDeferredPost),window.onbeforeunload=function(){sendLogs()};const shortHexRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,longHexRegex=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,rainbow=['#D92120','#E6642C','#E68E34','#D9AD3C','#B5BD4C','#7FB972','#63AD99','#55A1B1','#488BC2','#4065B1','#413B93','#781C81'],temperature=['#3D52A1','#3A89C9','#77B7E5','#B4DDF7','#E6F5FE','#FFFAD2','#FFE3AA','#F9BD7E','#ED875E','#D24D3E','#AE1C3E'],solar=['#FFFFE5','#FFF7BC','#FEE391','#FEC44F','#FB9A29','#EC7014','#CC4C02','#993404','#662506'];class Colour{static get red(){return'#D90000'}static get orange(){return'#F15A24'}static get yellow(){return'#edd200'}static get lime(){return'#b2d300'}static get green(){return'#00B200'}static get cyan(){return'#29ABE2'}static get blue(){return'#006DD9'}static get violet(){return'#662D91'}static get purple(){return'#9d0069'}static get pink(){return'#ED1E79'}static rainbow(e){let t=clamp$1(.4+.15*e,0,1);return tabulate$1((s)=>getColourAt(rainbow,t*s/(e-1)),e)}static temperature(e){let t=clamp$1(.1*e,0,1);return tabulate$1(function(s){return getColourAt(temperature,(1-t)/2+t*s/(e-1))},e)}static solar(e){return tabulate$1((t)=>getColourAt(solar,t/(e-1)),e)}constructor(e,t,s,n=1){this.r=e,this.g=t,this.b=s,this.a=n}static fromHex(e){e=e.replace(shortHexRegex,function(e,t,s,n){return t+t+s+s+n+n});let t=longHexRegex.exec(e);return t?new Colour(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)):new Colour(0,0,0)}static fromRgb(e){let t=e.replace(/rgba?\(/,'').replace(')','').split(',');return new Colour(+t[0],+t[1],+t[2],3<t.length?+t[3]:1)}get hex(){let e=[this.r,this.g,this.b].map((e)=>pad2(_Mathround(e).toString(16)));return'#'+e.join('')}get rgb(){let e=[this.r,this.g,this.b].map((e)=>_Mathround(e)).join(',');return'rgba('+e+','+this.a+')'}get hsl(){let e,t,s=this.r/255,n=this.g/255,i=this.b/255,a=_Mathmax(s,n,i),r=_Mathmin(s,n,i),o=(a+r)/2;if(a===r)e=t=0;else{let l=a-r;t=.5<o?l/(2-a-r):l/(a+r),a===s?e=(n-i)/l+(n<i?6:0):a===n?e=(i-s)/l+2:a===i?e=(s-n)/l+4:void 0,e/=6}return'hsl('+[e,t,o].join(',')+')'}toString(){return this.rgb}}class Draggable extends Evented$1{constructor(e,t,s='',n=0,i=!1,a=1){super();let r,o,l=this;this.$el=e,this._posn={x:null,y:null},this.move={x:'y'!==s,y:'x'!==s},this.useTransform=i,this.snap=a,this.disabled=!1,slide(e,{start:function(e){l.disabled||(r=e,o=!0,l.trigger('start'))},move:function(e){if(!l.disabled){o=!1;let t=clamp$1(l._posn.x+e.x-r.x,0,l.width),s=clamp$1(l._posn.y+e.y-r.y,0,l.height);r=e,l.position={x:t,y:s},l.trigger('drag')}},end:function(){l.disabled||l.trigger(o?'click':'end')}}),Browser.resize(function(){let e=l.width,s=l.height;l.width=t.width-2*n,l.height=t.height-2*n;let i=l.width/e*l._posn.x,a=l.height/s*l._posn.y;l.draw({x:i,y:a})})}get position(){return{x:roundTo(this._posn.x,this.snap),y:roundTo(this._posn.y,this.snap)}}set position(e){this.draw(e),this._posn=e,this.trigger('move',e)}draw({x:e,y:t}){this.snap&&(e=roundTo(e,this.snap),t=roundTo(t,this.snap)),this.useTransform?this.$el.translate(this.move.x?_Mathround(e):0,this.move.y?_Mathround(t):0):(this.move.x&&this.$el.css('left',_Mathround(e)+'px'),this.move.y&&this.$el.css('top',_Mathround(t)+'px'))}}'scrollRestoration'in history&&(history.scrollRestoration='manual');const onPopState=function(){let t=!1;return'complete'===document.readyState?t=!0:window.addEventListener('load',function(){setTimeout(function(){t=!0})}),function(s){t&&s.state&&this.goToState(s.state)}}(),customElementOptions=new Map;class CustomHTMLElement extends HTMLElement{connectedCallback(){if(this._wasConnected)return void this.$el.trigger('connected');this._wasConnected=!0,this._isReady=!1,this.$el.created&&this.$el.created();const e=customElementOptions.get(this.$el.tagName);(e.template||e.templateId)&&applyTemplate(this,e);let t=customElementChildren(this).filter((e)=>!e._isReady).map((e)=>new Promise((t)=>e.addEventListener('_ready',t)));Promise.all(t).then(()=>{this.$el.ready&&this.$el.ready(),this.dispatchEvent(new CustomEvent('_ready')),this._isReady=!0})}disconnectedCallback(){this.$el.trigger('disconnected')}attributeChangedCallback(e,t,s){this.$el.trigger('attr:'+e,{newVal:s,oldVal:t})}}class CustomElement extends Element{created(){}ready(){}}class Blank extends CustomElement{ready(){this.choices=this.attr('choices').split('|'),this.removeAttr('choices'),this.done=!1,this.$target=this.$('.target');const e=this.$('.popup'),t=intArray(this.choices.length);this.setClass('left',this.$target.bounds.left+e.width>Browser.width-15),t.forEach((t)=>{let s=$N('div',{class:'choice',html:this.choices[t]},e);s.on('click',()=>{this.removeClass('on'),t?(this.$target.html=this.choices[t],this.addClass('invalid'),this.trigger('invalid')):(this.solve(),this.trigger('valid',this.choices[0]))})}),this.on('hover',{enter:()=>{if(!this.done){this.addClass('on');const t=this.$target.bounds,s=e.width,n=e.height;this.setClass('left',t.left+s>Browser.width-15),this.setClass('top',t.top+t.height+n>Browser.height-10)}},exit:()=>{this.removeClass('on')},delay:100,$clickTarget:this.$target})}solve(){this.done=!0,this.$target.html=this.choices[0],this.removeClass('on invalid'),this.addClass('done')}}class BlankInput extends CustomElement{ready(){const e=this.solution=this.attr('solution');this.removeAttr('solution'),this.done=!1,this.$input=this.$('input'),this.$target=this.$('.target'),e.match(/^[0-9]+$/)?this.$input.setAttr('pattern','[0-9]*'):Browser.isMobile&&this.$input.setAttr('type','number');let t='',s=0;this.$input.change((s)=>{if(s.match('^[0-9]+/[0-9]+$')){const e=s.split('/');s=''+ +e[0]/+e[1]}s.match('^[0-9]+,[0-9]+$')&&(s=s.replace(',','.')),t=s,(s===e||toWord(s)===e||s===toWord(e))&&(this.solve(),this.trigger('valid',t))}),this.$input.on('focus',()=>{this.addClass('on'),this.removeClass('invalid'),this.$input.setAttr('placeholder',' ')}),this.$input.on('blur',()=>{this.removeClass('on'),this.setClass('invalid',t&&!this.done),this.$input.setAttr('placeholder','???'),t&&!this.done&&(s+=1,3<=s?this.trigger('hint',this.solution):this.trigger('invalid'))})}solve(){this.done=!0,this.$input.remove(),this.$target.html=this.solution.replace(/^-/,'\u2013'),this.addClass('done')}}registerElement('x-blank-input',BlankInput,{templateId:'#blank-input'}),registerElement('x-blank',Blank,{templateId:'#blank'});const FUNCTION_STEP=2,GRID_SPACING=80,GRID_STEPS=[5,2,1],TICK_LENGTH=4;class CoordinateSystem extends CustomElement{ready(){const e=+this.attr('width')||600,t=+this.attr('height')||400,s=this.$('svg');s.setAttr('width',e),s.setAttr('height',t),s.setAttr('viewBox',`0 0 ${e} ${t}`),this.$grid=$N('g',{class:'grid'},s),this.$xAxis=$N('line',{class:'axis'},s),this.$yAxis=$N('line',{class:'axis'},s),this.$plot=$N('g',{class:'plot'},s),this.$labels=$N('g',{class:'labels'},s);const n=this.hasAttr('margins')?words$1(this.attr('margins')):[20,20,20,20];this.mathBounds=new Bounds(-5,5,0,10),this.plotBounds=new Bounds(+n[3],e-n[1],t-n[2],+n[0]),this.plotOrigin=new Point(0,0),this.xAxisOptions=this.attr('x-axis').split('|'),this.yAxisOptions=this.attr('y-axis').split('|'),this.xSuffix=this.attr('x-suffix'),this.ySuffix=this.attr('y-suffix'),this.xLabel=this.attr('x-label'),this.yLabel=this.attr('y-label'),this.plotType=this.attr('plot-type')||'line',this.plotStyle=this.attr('plot-style')||'red',this.getCrosshairPosn=(e)=>e,this.setupCrosshairs(s,e)}setupCrosshairs(t,e){const s=$N('g',{class:'crosshair '+this.plotStyle},t),n=$N('path',{},s),i=$N('circle',{r:4},s),a=$N('text',{},s);let r=new Point(0,0);const o=(s)=>{const o=this.plotToMathCoords(svgPointerPosn(s,t)),l=this.getCrosshairPosn(o);if(!l.equals(r)){r=l;const t=this.mathToPlotCoords(l);i.setCenter(t),n.points=[new Point(this.plotOrigin.x,t.y),t,new Point(t.x,this.plotOrigin.y)],a.text=`(${l.x}, ${numberFormat(l.y,5)})`;const s=a.width;a.setAttr('x',t.x+8+s<e?t.x+5:t.x-s-5),a.setAttr('y',20<t.y?t.y-7:t.y+18)}};t.on('touchstart mouseover',(t)=>{s.show(),o(t)},{passive:!0}),t.on('touchend mouseout',()=>s.hide(),{passive:!0}),t.on('pointermove',o)}mathToPlotCoords(e){return e.changeCoordinates(this.mathBounds,this.plotBounds)}plotToMathCoords(e){return e.changeCoordinates(this.plotBounds,this.mathBounds)}setPoints(e,t=1){const s=e.map((e,s)=>new Point(s+t,e));this.setSeries(s)}setSeries(...e){const t=computeAxis(this.xAxisOptions,this.plotBounds.dx,[0,_Mathmax(...e.map((e)=>last$1(e).x))]),s=t[0],n=t[1],i=t[2];this.mathBounds.xMin=s,this.mathBounds.xMax=n;const a=computeAxis(this.yAxisOptions,this.plotBounds.dy,getDataBounds(e)),r=a[0],o=a[1],l=a[2];this.mathBounds.yMin=r,this.mathBounds.yMax=o,this.drawAxes(i,l),this.$plot.removeChildren();for(let t of e)this.drawLinePlot(t);this.getCrosshairPosn=(t)=>e[0].reduce((e,s)=>_Mathabs(s.x-t.x)<=_Mathabs(e.x-t.x)?s:e)}setFunctions(...e){const t=computeAxis(this.xAxisOptions,this.plotBounds.dx,[-5,5]),s=t[0],n=t[1],i=t[2];this.mathBounds.xMin=s,this.mathBounds.xMax=n;const a=e.map(()=>[]);for(let t,s=this.plotBounds.xMin;s<this.plotBounds.xMax;s+=FUNCTION_STEP){t=this.plotToMathCoords(new Point(s,0)).x;for(let s=0;s<e.length;++s)a[s].push(new Point(t,e[s](t)))}const r=computeAxis(this.yAxisOptions,this.plotBounds.dy,getDataBounds(a)),o=r[0],l=r[1],d=r[2];this.mathBounds.yMin=o,this.mathBounds.yMax=l,this.drawAxes(i,d),this.$plot.removeChildren();for(let t of a)this.drawLinePlot(t);this.getCrosshairPosn=(t)=>{const a=roundTo(clamp$1(t.x,s,n),i/20);return new Point(_round(a,3),e[0](a))}}drawAxes(e,t){const s=[this.mathBounds,this.plotBounds],n=s[0],i=s[1],a=getOrigin(this.mathBounds);this.plotOrigin=this.mathToPlotCoords(a),this.$xAxis.setLine({x:i.xMin,y:this.plotOrigin.y},{x:i.xMax,y:this.plotOrigin.y}),this.$yAxis.setLine({x:this.plotOrigin.x,y:i.yMin},{x:this.plotOrigin.x,y:i.yMax}),this.$grid.removeChildren(),this.$labels.removeChildren();for(let s=n.xMin+e;s<n.xMax;s+=e){if(s===a.x)continue;const e=this.mathToPlotCoords(new Point(s,0)).x;$N('line',{x1:e,y1:i.yMin,x2:e,y2:i.yMax},this.$grid),$N('text',{text:numberFormat(s,4)+this.xSuffix,x:e,y:this.plotOrigin.y+18,"text-anchor":'middle'},this.$labels),$N('line',{class:'tick',x1:e,y1:this.plotOrigin.y,x2:e,y2:this.plotOrigin.y+TICK_LENGTH},this.$grid)}for(let s=n.yMin+t;s<n.yMax;s+=t){if(s===a.y)continue;const e=this.mathToPlotCoords(new Point(0,s)).y;$N('line',{x1:i.xMin,y1:e,x2:i.xMax,y2:e},this.$grid),$N('text',{text:numberFormat(s,4)+this.ySuffix,x:this.plotOrigin.x-8,y:e+4,"text-anchor":'end'},this.$labels),$N('line',{class:'tick',x1:this.plotOrigin.x,y1:e,x2:this.plotOrigin.x-TICK_LENGTH,y2:e},this.$grid)}0!==n.xMin||0!==n.yMin||this.ySuffix||this.ySuffix?0===n.yMin?$N('text',{text:numberFormat(a.x,4)+this.xSuffix,x:this.plotOrigin.x,y:this.plotOrigin.y+18,"text-anchor":'middle'},this.$labels):$N('text',{text:numberFormat(a.y,4)+this.ySuffix,x:this.plotOrigin.x-8,y:this.plotOrigin.y+4,"text-anchor":'end'},this.$labels):$N('text',{text:0,x:this.plotOrigin.x-5,y:this.plotOrigin.y+15,"text-anchor":'end'},this.$labels),this.xLabel&&$N('text',{text:this.xLabel,x:this.plotBounds.xMax-2,y:this.plotOrigin.y-12,"text-anchor":'end'},this.$labels),this.yLabel&&$N('text',{text:this.yLabel,x:this.plotOrigin.x+10,y:this.plotBounds.yMax+5},this.$labels)}drawLinePlot(e){const t=$N('g',{class:this.plotStyle},this.$plot),s=$N('path',{},t),n=e.map((e)=>this.mathToPlotCoords(e));if(s.points=n,'points'===this.plotType)for(let e of n)$N('circle',{r:4,cx:e.x,cy:e.y},t)}}registerElement('x-coordinate-system',CoordinateSystem,{templateId:'#coordinate-system'});class CoordinateSketch extends CustomElement{ready(){let e=600,t=400,s=this.$('svg'),n=s.$('.axes'),i=s.$('.validation'),a=(t)=>t+e/2,r=(e)=>t/2-e,o=this.attr('validate');o&&(o=o.split(':'));for(let s=50-t/2;s<t/2;s+=50)$N('line',{x1:0,x2:e,y1:r(s),y2:r(s),class:s?'axis':'axis primary'},n);for(let s=50-e/2;s<e/2;s+=50)$N('line',{x1:a(s),x2:a(s),y1:t,y2:0,class:s?'axis':'axis primary'},n)}}registerElement('x-coordinate-sketch',CoordinateSketch,{templateId:'#coordinate-sketch'});const keys=Browser.keyCodes,FN_NAMES={"+":'addition',"*":'multiplication',"/":'fractions or division',"-":'subtraction',sqrt:'square roots',"^":'powers'};class Equation extends CustomElement{ready(){this.$math=this.$('.math'),this.$textarea=this.$('textarea'),this.isDone=!1,this.error=null,this.errorCount=0,this.solution=new Expression(this.attr('solution')),this.removeAttr('solution'),this.validationFn=this.attr('validate'),this.allowedVars=this.hasAttr('vars')?words$1(this.attr('vars')):this.solution?this.solution.variables:[],this.allowedFns=this.hasAttr('fns')?words$1(this.attr('fns')):this.solution?this.solution.functions:[];const t=this.$('.cursor'),e=this.$('.keys'),s=this.$('.error-message'),n=this.getModel().$step;this.on('pointerdown',(s)=>{if(!this.isDone){s.preventDefault(),this.addClass('active'),this.$textarea.focus();const e=$(s.target),n=pointerPosition(s).x<e.boxCenter.x;'MROW'===e.tagName?n?e.prepend(t):e.append(t):'M'===e.tagName[0]?n?e.insertBefore(t):e.insertAfter(t):('X-EQUATION'===e.tagName||e.hasClass('math'))&&(n?this.$math.prepend(t):this.$math.append(t))}}),this.$textarea.on('blur',()=>{if(!this.isDone){if(this.removeClass('active'),this.error){const e=n.addHint(this.error,{className:'incorrect'});s.html=e.text,this.errorCount+=1,5<=this.errorCount&&n.addHint(`Hmmm… maybe try ${this.solution.mathML}?`)}this.setClass('has-error',!!this.error)}}),this.$textarea.on('keydown',(s)=>{if(isOneOf$1(s.keyCode,keys.enter,keys.escape))this.$textarea.blur();else if(s.keyCode===keys.left)goLeft(t);else if(s.keyCode===keys.right)goRight(t);else if(s.keyCode===keys.up)goUp(t);else if(s.keyCode===keys.down)goDown(t);else if(isOneOf$1(s.keyCode,keys.backspace,keys.delete))backspace(t),this.validate();else{let e=(s.key||String.fromCharCode(s.which)).toLowerCase();e=e.replace('*','\xD7').replace('/','\xF7').replace('-','\u2013'),type(t,e),this.validate()}});for(let s of e.children)s.on('pointerdown',(t)=>t.preventDefault()),s.on('pointerup',()=>{type(t,s.data.type),this.validate()})}validate(){const e=parseInput(this.$math);if('error'in e)return this.error=e.error;if(this.solution&&this.solution.numEquals(e.expr))return this.complete(e.expr);const t=checkVariables(e.expr,this.allowedVars,this.allowedFns);if(t)return this.error=t;if(this.validationFn){const t=this.getModel()[this.validationFn](e.expr);if(t&&t.isCorrect)return this.complete(e.expr);if(t&&t.error)return this.error=t.error}this.error='incorrect'}complete(e){this.isDone||(this.isDone=!0,this.removeClass('has-error active'),this.addClass('done'),this.trigger('solve',{expr:e}))}solve(){this.$math.removeClass('empty'),this.$math.html=this.solution.mathML,this.complete(this.solution),this.$textarea.blur()}}registerElement('x-equation',Equation,{templateId:'#equation'});class EquationSystem extends CustomElement{ready(){let e=this.$('table'),t=e.$('tr:last-child').html;const s=({expr:i,final:a})=>{if(a)return this.trigger('complete');let r=n,o=$N('tr',{html:t},e);n=o.$('x-equation'),n.on('solve',s),n.$('[contenteditable]').focus(),n.props.validate=function(e){return e.same(i)?{error:'You\u2019ve already had this before.'}:r.props.validate(e)}};let n=this.$('x-equation');n.on('solve',s)}}registerElement('x-equation-system',EquationSystem);class Gallery extends CustomElement{ready(){function e(e){A=e,p.translateX(e),l.trigger('move',e)}function t(e){C=e,m.forEach(function(t,s){t.setClass('on',s>=e&&s<e+f)}),h.setClass('disabled',e===w-f),g.setClass('disabled',0===e),l.trigger('change',e)}function s(){x=l.width,f=k?_Mathceil(x/k):1,y=x/f,c.forEach(function(e){e.css('width',y+'px')}),p.css('width',w*y+'px'),e(-C*y),t(C)}function n(){v=Date.now()-_,e($+b*ease(S,v/T))}function i(){!E&&v<T&&requestAnimationFrame(i),n()}function a(e){E=!1,v=0,$=A,b=-e*y-A,_=Date.now(),t(e),i()}function r(){S='quad',C<w-f&&a(C+1)}function o(){S='quad',0<C&&a(C-1)}const l=this,d=this.$('.wrapper'),p=this.$('.panel'),c=p.children,h=this.$('.next'),g=this.$('.back'),u=this.$('.dots'),m=c.map(()=>$N('div',{class:'dot'},u));let x,f,y,v,$,b,_,w=c.length,k=this.attr('slide-width')||null,C=0,A=0,S='quad',T=500,E=!1;h.on('click',r),g.on('click',o);let M=null,O=null,I=null,P=null;slide(d,{start(e){E=!0,M=A,O=e.x,P=I=O},move(t){I=P,P=t.x;let s=M-O+t.x,n=-(w-f)*y,i=0<s?s/4:s<n?n+(s-n)/4:s;e(i),l.css('pointer-events','none')},end(){let e=P-I,t=12<e?1:-12>e?-1:0;S='quad-out',a(clamp$1(_Mathround(-A/y-t),0,w-f)),setTimeout(()=>l.css('pointer-events','auto'))}}),Browser.resize(s),this.goNext=r,this.goBack=o}}registerElement('x-gallery',Gallery,{templateId:'#gallery'});class Gameplay extends CustomElement{ready(){this.playing=!1,this.completed=!1,this.addClass('paused');let e=this.$('.slide-template');this.slideTemplate=e.html,e.remove(),this.$progress=this.$('.progress'),this.time=+this.attr('time')||8e3,this.slideGenerator=noop$1,this.$currentSlide=null,this.currentAnimation=null,this.$dots=this.$('.dots'),this.goal=(this.attr('goal')||'6/8').split('/').map((e)=>+e),this.$dots.css('margin-left',-8*this.goal[1]+'px');for(let e=0;e<this.goal[1];++e)$N('div',{class:'dot'},this.$dots);this.history=[],this.$('.toggle').on('click',()=>{this[this.playing?'pause':'play']()})}score(e){if(this.$dots.children[this.history.length].addClass(e?'green':'red'),this.history.push(e),!this.completed&&total$1(this.history)>=this.goal[0])return this.completed=!0,this.$('x-solved').enter(),this.trigger('score'),this.pause(),!0}makeSlide(){function e(t){s.trigger('error',t),i(!1)}if(!this.playing)return;if(this.history.length>=this.goal[1]){this.history.shift(),this.$dots.animate({transform:['none','translateX(-16px)']},300).then(()=>{this.$dots.css('transform','none')});let e=this.$dots.children[0];e.exit('fade',300).then(()=>{e.remove()});let t=$N('div',{class:'dot'},this.$dots);t.enter('fade',300)}if(this.$currentSlide){let e=this.$currentSlide;e.animate({transform:['none','translateX(-100%)']},400).then(()=>{e.remove()})}let s=$N('div',{class:'slide',html:this.slideTemplate},this);s.animate({transform:['translateX(100%)','none']},400);let n=this.time*(1-total$1(this.history)/this.goal[1]/2),t=this.$progress.animate({width:['100%','0%']},n,400,'linear');const i=(e)=>{s.addClass('done');let n=this.score(e);t.cancel(),n||setTimeout(()=>this.makeSlide(),1e3)};t.then(e),this.$currentSlide=s,this.currentAnimation=t,this.slideGenerator(s,function(t){s.trigger('success',t),i(!0)},e)}setFirstSlide(e){this.$currentSlide=$N('div',{class:'slide',html:this.slideTemplate},this),e(this.$currentSlide)}play(){this.playing||(this.playing=!0,this.removeClass('paused'),this.makeSlide(),this.$('x-solved').hide())}pause(){this.playing&&(this.playing=!1,this.currentAnimation.cancel(),this.addClass('paused'))}}registerElement('x-gameplay',Gameplay,{templateId:'#gameplay'});class GeoElement{constructor(e,t,s,n){this.x=t,this.name=n||e.model.name(),this.$geopad=e,this.removed=!1,this.$el=s||this.makeEl(),e.elements.set(this.name,this),this.$el.hasAttr('label')&&this.setLabel(this.$el.attr('label')),this.val=t(e.model),this.val&&e.model.set(this.name,this.val),e.model.watch((e)=>{if(!this.removed&&(this.val=this.x(e),this.$el.setClass('hidden',!this.val),(this.val||this.name in e)&&(e[this.name]=this.val),!!this.val)){const t=this.val.transform(this.$geopad.grid);this.update(t),this.$label&&this.updateLabel(e,t)}})}setLabel(e,t=null,s=null){this.$label||(this.$label=makeLabel(this.$el,this.$geopad,t)),this.labelStr=parse(e),this.labelPosition=s?parse(s,!0):null}updateLabel(e,t){if(this.$label.text=this.labelStr(e),this.labelPosition){const t=this.labelPosition(e);this.$label.transform=`translate(${t.x}px, ${t.y+5}px)`}else this.$label.transform=labelPosn(t,this.$el,this.$geopad)}remove(e=400){this.$label&&this.$label.exit(),this.exit(e).then(()=>{this.$geopad.elements.delete(this.name),this.removed=!0})}}class GeoPath extends GeoElement{constructor(e,t,s,n){super(e,t,s,n),this.points=[]}update(e){try{this.$el.setAttr('d',draw(e,this.$el,this.$geopad))}catch(t){this.$el.setAttr('d','')}}makeEl(){return $N('path',{},this.$geopad.$paths)}exit(e){return this.$el.exit('draw',e)}}class GeoPoint extends GeoElement{makeEl(){return $N('circle',{r:4},this.$geopad.$points)}exit(e){return this.$el.exit('pop',e)}update(e){this.$el.setCenter(e),this.$halo&&this.$halo.setCenter(e)}addHalo(){this.$halo=$N('circle',{class:'halo',r:18},this.$geopad.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter('pop')}removeHalo(){this.$halo&&this.$halo.exit('pop').then(()=>{this.$halo.remove(),this.$halo=null})}}class GeoMovablePoint extends GeoPoint{constructor(e,t,s,n,i){let a=!0;const r=(e)=>{const s=a?t:e[this.name];return i?i(e).project(s):s};super(e,r,s,n),a=!1,this.$el.hasClass('pulsate')&&this.pulsate(),this.project=(t)=>{i=t,e.model.update()},this.locked=!1}pulsate(){this.$pulse=$N('circle',{class:'pulse',r:8},this.$geopad.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one('mouseover pointerdown',()=>this.$pulse.remove())}lock(){this.$el.removeClass('move'),this.$el.setAttr('r',4),this.locked=!0}makeEl(){return $N('circle',{class:'move',r:8},this.$geopad.$points)}}class GeoTool{constructor(e){this.$geopad=e,this.startPoint=null,this.endPosn=null,this.pending=null}start(){}move(){}end(){}click(){}cancel(){}addMovablePoint(e){if(this.$geopad.noPoints)return{val:e};const t=new GeoMovablePoint(this.$geopad,e);return this.$geopad.trigger('add:point',t),t}}class MoveTool extends GeoTool{start(e){e&&e instanceof GeoMovablePoint&&!e.locked&&(this.startPoint=e)}move(e,t){this.startPoint&&!this.startPoint.val.equals(t)&&this.$geopad.model.set(this.startPoint.name,t)}end(){this.startPoint=null,this.$geopad.trigger('moveEnd',this.startPoint)}}class PointTool extends MoveTool{click(e,t){e||this.addMovablePoint(t)}}class DrawTool extends GeoTool{constructor(e){super(e),this.clicked=!1}start(e,t){if(!this.pending){this.startPoint=e||this.addMovablePoint(t),this.endPosn=this.startPoint.val;this.pending=new GeoPath(this.$geopad,()=>this.constructor.path(this.startPoint.val,this.endPosn)),this.pending.$el.addClass('thin'),this.$geopad.trigger('begin:path',this.pending)}}move(e,t){this.pending&&(this.endPosn=e?e.val:t,this.$geopad.model.update())}end(e,t){if(!this.pending)return;if(e===this.startPoint)return this.cancel();const s=this.pending;s.points=[this.startPoint,e||this.addMovablePoint(t)],s.$el.removeClass('thin'),s.x=()=>this.constructor.path(s.points[0].val,s.points[1].val),this.$geopad.model.update(),this.$geopad.trigger('add:path',s),this.startPoint=this.endPosn=this.pending=null,this.clicked=!1}click(e,t){return this.pending?this.clicked?void this.end(e,t):this.clicked=!0:void 0}hover(e,t){this.pending&&this.move(e,t)}cancel(){this.pending&&this.pending.remove(),this.startPoint=this.endPosn=this.pending=null,this.clicked=!1}}class LineTool extends DrawTool{static path(e,t){return new Segment(e,t)}}class CircleTool extends DrawTool{static path(e,t){const s=Point.distance(e,t);return new Circle(e,s)}}class RectangleTool extends DrawTool{static path(e,t){return new Rectangle(e,t.x-e.x,t.y-e.y)}}class PerpBisectorTool extends DrawTool{static path(e,t){return new Segment(e,t).perpBisector}}class AngleBisectorTool extends GeoTool{click(e,t){if(e||(e=this.addMovablePoint(t)),!this.startPoint)this.startPoint=[e],e.addHalo();else if(1===this.startPoint.length){this.startPoint.push(e),e.addHalo(),this.endPosn=e.val;this.pending=new GeoPath(this.$geopad,()=>new Angle(this.startPoint[0].val,this.startPoint[1].val,this.endPosn).bisector),this.$geopad.trigger('begin:path',this.pending)}else if(2===this.startPoint.length){const t=[...this.startPoint,e];this.pending.$el.removeClass('thin'),this.pending.x=()=>new Angle(...t.map((e)=>e.val)).bisector,this.$geopad.model.update(),this.$geopad.trigger('add:path',this.pending);for(let e of this.startPoint)e.removeHalo();this.startPoint=this.endPosn=this.pending=null}}hover(e,t){this.pending&&(this.endPosn=e?e.val:t,this.$geopad.model.update())}cancel(){if(this.pending){this.pending.remove();for(let e of this.startPoint)e.removeHalo()}this.startPoint=this.endPosn=this.pending=null}}const COMPASS='M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z',RULER='M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z',MODEL_FUNCTIONS={pi:_MathPI,point:(e,t)=>new Point(e,t),angle:(e,t,s)=>new Angle(e,t,s),line:(e,t)=>new Line(e,t),ray:(e,t)=>new Ray(e,t),segment:(e,t)=>new Segment(e,t),circle:(e,t)=>new Circle(e,t),arc:(e,t,s)=>new Arc(e,t,s),polygon:(...e)=>new Polygon(...e),polyline:(...e)=>new Polyline(...e),triangle:(e,t,s)=>new Triangle(e,t,s),rectangle:(e,t,s,n)=>new Rectangle(e,t,s,n),distance:Point.distance,round:(e,t=0)=>_round(e,t),intersections};class Geopad extends CustomElement{ready(){function t(t){return t.clamp(5,e-5,5,s-5).transform(i).round()}const e=+(this.attr('width')||this.width),s=+(this.attr('height')||e);this.box=new Rectangle(new Point(0,0),e,s).polygon,this.css({width:e+'px',height:s+'px'}),this.hasClass('sticky')&&this.css('top',`calc(50vh - ${s/2}px)`),this.$svg=this.children.filter((e)=>'SVG'===e.tagName)[0],this.model=this.getModel(),this.model.assign(MODEL_FUNCTIONS),this.elements=new Map,this.findIntersections=this.hasAttr('intersect'),this.noPoints=this.hasAttr('no-points'),this.cachedIntersections=null,this.model.watch(()=>this.cachedIntersections=null);const n=+this.attr('grid')||null,i=n?[[1/n,0,-.5],[0,1/n,-.5]]:null;if(this.grid=n?[[n,0,n/2],[0,n,n/2]]:null,n){const t=$N('g',{class:'grid'},this.$svg);for(let a=n/2;a<e;a+=n)$N('line',{x1:a,x2:a,y1:0,y2:s},t);for(let a=n/2;a<s;a+=n)$N('line',{x1:0,x2:e,y1:a,y2:a},t)}this.$paths=$N('g',{class:'paths'},this.$svg),this.$pulses=$N('g',{class:'pulses'},this.$svg),this.$points=$N('g',{class:'points'},this.$svg),this.$labels=$N('g',{class:'labels'},this.$svg);for(const e of this.$svg.$$('path[x], circle')){const t=e.hasAttr('x')?parse(e.attr('x'),!0):null,s=e.hasAttr('project')?parse(e.attr('project'),!0):null,n=e.attr('name')||this.model.name();'PATH'===e.tagName?(e.moveTo(this.$paths),new GeoPath(this,t,e,n)):(e.moveTo(this.$points),e.hasClass('move')?(e.setAttr('r',8),new GeoMovablePoint(this,e.center,e,n,s)):t&&(e.setAttr('r',4),new GeoPoint(this,t,e,n)))}const a={move:new MoveTool(this),point:new PointTool(this),line:new LineTool(this),circle:new CircleTool(this),perpBisector:new PerpBisectorTool(this),angleBisector:new AngleBisectorTool(this),rectangle:new RectangleTool(this)};this.$tools=this.$('.tools');let r=a[this.$tools.$active.data.tool];this.$tools.on('change',(e)=>r=a[e.data.tool]),slide(this.$svg,{start:(e)=>r.start(this.vertexAt(e),t(e)),move:(e)=>r.move(this.vertexAt(e),t(e)),end:(e,s)=>{const n=10>Point.distance(e,s)?'click':'end';r[n](this.vertexAt(e),t(e))}}),this.$svg.on('mousemove',(s)=>{if(r.hover){const e=svgPointerPosn(s,this.$svg);r.hover(this.vertexAt(e),t(e))}}),Browser.onKey('escape',()=>r.cancel())}eval(e){return parse(e,!0)(this.model)}get points(){const e=Array.from(this.elements.values());return e.filter((t)=>t instanceof GeoPoint&&t.val&&!t.removed)}get paths(){const e=Array.from(this.elements.values());return e.filter((t)=>t instanceof GeoPath&&t.val&&!t.removed)}get intersections(){if(!this.findIntersections)return[];if(this.cachedIntersections)return this.cachedIntersections;const e=this.paths,t=[];for(let s of e)for(let n of e){if(s===n)continue;const e=intersections(s.val,n.val);for(let a=0;a<e.length;++a){const i=()=>intersections(s.val,n.val)[a];t.push({val:e[a],x:i})}}return this.cachedIntersections=t,t}vertexAt(e){let t=null,s=Infinity,n=this.grid?this.grid[0][0]/2:20;for(let i of[...this.points,...this.intersections]){const a=Point.distance(e,i.val.transform(this.grid));a<n&&a<s-1&&(s=a,t=i)}return t instanceof GeoPoint?t:t?this.drawPoint(t.x,{animate:!1}):void 0}setActiveTool(e){this.$tools.makeActive(this.$(`.tool[data-tool="${e}"]`))}drawPath(e,{classes:t='',animate:s=0,target:n='',name:i=''}={}){const a=$N('path',{class:t,target:n},this.$paths);isString$1(e)&&(e=parse(e,!0));const r=new GeoPath(this,e,a,i);return s&&a.enter(a.hasClass('fill')?'fade':'draw',s),r}drawPoint(e,{classes:t='',animate:s=!0,target:n='',name:i=''}={}){const a=$N('circle',{r:4,class:t,target:n},this.$points);isString$1(e)&&(e=parse(e,!0));const r=new GeoPoint(this,e,a,i);return s&&a.enter('pop'),r}drawMovablePoint(e,{classes:t='',animate:s=!0,target:n='',name:i=''}={}){const a=$N('circle',{r:4,class:t,target:n},this.$points),r=new GeoMovablePoint(this,e,a,i);return s&&a.enter('pop'),r}animatePoint(e,t,s=400){const n=new Line(this.model[e],t);animate((t)=>this.model.set(e,n.at(t)),s)}animateConstruction(e,t=2e3){let s=this.elements.get(e),n=s.val;if(n instanceof Circle&&(n=n.arc),n instanceof Line){this.$ruler||(this.$ruler=$N('path',{d:RULER,class:'sketch'},this.$svg));const e=getToolTransform(n.at(-.1),12,n.angle-.3,1.2*n.length),i=getToolTransform(n.at(-.1),12,n.angle,1.2*n.length);return this.$ruler.show(),s.$el.hide(),this.$ruler.animate({opacity:[0,1],transform:[e,i]},500).then(()=>s.$el.enter('draw',t)).then(()=>this.$ruler.animate({opacity:[1,0],transform:[i,e]},500))}if(n instanceof Arc){this.$compass||(this.$compass=$N('path',{d:COMPASS,class:'sketch'},this.$svg));const e=getToolTransform(n.c,50,n.startAngle,1.5*n.radius),i=getToolTransform(n.c,50,n.startAngle,n.radius),a=getToolTransform(n.c,50,n.startAngle+n.angle,n.radius),r=getToolTransform(n.c,50,n.startAngle+n.angle,1.5*n.radius);return this.$compass.show(),s.$el.hide(),this.$compass.animate({opacity:[0,1],transform:[e,i]},500).then(()=>(s.$el.enter('draw',t),this.$compass.animate({transform:[i,a]},t,0,'linear'))).then(()=>this.$compass.animate({opacity:[1,0],transform:[a,r]},500))}}showGesture(e,t){this.$gesture||(this.$gesture=$N('x-gesture',{},this)),this.$gesture.stop(),e=parse(e,!0)(this.model),this.$gesture.from=e,t?(t=parse(t,!0)(this.model),this.$gesture.start(t.subtract(e))):this.$gesture.start(),this.one('click mouseover pointerdown',()=>this.$gesture.stop())}waitForPath(e){const t=defer$1(),s=()=>{for(let n of this.paths)if(e(n))return t.resolve(n),void this.off('add:path moveEnd',s)};return this.on('add:path moveEnd',s),t.promise}waitForPaths(e,{onCorrect:t,onIncorrect:s,onHint:n,onComplete:a,maxErrors:r=4}){const o=e.map((e)=>isString$1(e)?parse(e,!0):()=>e),l=tabulate$1(!1,e.length);let d=0,p=!1;this.on('add:path',(e)=>{if(!p){const c=o.findIndex((t)=>t(this.model).equals(e.val));if(0<=c)return l[c]?e.remove(0):(l[c]=!0,t&&t(e,c),d=0,void(l.every((e)=>e)&&(p=!0,a&&a(!1))));if(e.remove(),!(1>e.val.length))if(d+=1,d>=r){const e=l.findIndex((e)=>!e),t=this.drawPath(o[e],{animate:1e3});l[e]=!0,n&&n(t,e),d=0,l.every((e)=>e)&&(p=!0,a&&a(!0))}else s&&s(e)}})}}registerElement('x-geopad',Geopad,{templateId:'#geopad',model:!0});class Gesture extends CustomElement{created(){this.doAnimation=!1,this.from=null;const e=this.attr('slide');this.slide=e?new Point(...e.split(',').map((e)=>+e)):null}ready(){this.$target=$(this.attr('target')),this.$target&&this.$target.on('click mouseover pointerdown',()=>this.stop())}start(e){this.doAnimation||(this.doAnimation=!0,e||this.slide?this._runSlideAnimation(e||this.slide):this._runClickAnimation())}stop(){this.doAnimation=!1}_getPosition(){const e=this.$target.positionLeft-this.positionLeft+this.$target.width/2,t=this.$target.positionTop-this.positionTop+this.$target.height/2;return{x:e,y:t}}_runSlideAnimation(e){this.show();const t=this.from||this._getPosition(),s=`translate(${t.x-15}px,${t.y-10}px)`,n=`translate(${t.x+e.x-15}px,${t.y+e.y-10}px)`;this.animate({transform:[s+' scale(2)',s],opacity:[0,1]},300).then(()=>this.animate({transform:[s,n]},1e3)).then(()=>this.animate({transform:[n,n+' scale(2)'],opacity:[1,0]},300)).then(()=>{this.hide(),setTimeout(()=>{this.doAnimation&&this._runSlideAnimation(e)},1e3)})}_runClickAnimation(){this.show();const e=this.from||this._getPosition(),t=`translate(${e.x-15}px,${e.y-10}px)`;this.animate({transform:[t+' scale(2)',t],opacity:[0,1]},500).then(()=>this.animate({transform:[t,t+' scale(2)'],opacity:[1,0]},500,200)).then(()=>{this.hide(),setTimeout(()=>{this.doAnimation&&this._runClickAnimation()},1e3)})}}registerElement('x-gesture',Gesture,{templateId:'#gesture'});const glossary=JSON.parse($('#glossary').text),bios=JSON.parse($('#bios').text),$overlay=$N('div',{class:'gloss-overlay'},$body),$floatingWrap=$N('div',{class:'gloss-floating-wrap'},$body),$floating=$N('div',{class:'gloss-floating'},$floatingWrap);let activeGloss=null;Browser.resize(()=>{activeGloss&&activeGloss.hide()});class Gloss extends CustomElement{ready(){this.xid=this.attr('xid'),this.$target=this.$('.target'),this.$popup=this.$('.popup'),this.$popup.html=this.body()||'',this.setClass('left',600<Browser.width&&this.$target.bounds.left+this.$popup.width>Browser.width-15),this.on('hover',{enter:()=>this.show(),exit:()=>this.hide(),delay:100,$clickTarget:this.$target})}show(){if(activeGloss=this,this.addClass('on'),600>=Browser.width)return $floating.html=this.body(),$floatingWrap.enter('pop',300),void $overlay.enter('fade',300);const e=this.$target.bounds,t=this.$popup.width,s=this.$popup.height,n=e.top+e.height+s<Browser.height-10,i=60<e.top-s;this.setClass('top',i&&!n),this.setClass('left',e.left+t>Browser.width-15)}hide(){activeGloss=null,this.removeClass('on'),600>=Browser.width&&($floatingWrap.exit('pop',300),$overlay.exit('fade',300))}body(){const e=glossary[this.xid];if(!e)return console.warn('missing gloss:',this.xid);const t=e.image?`<img class="gloss-img" src="/resources/shared/glossary/${e.image}"/>`:'';return e.text+t}}class Bio extends Gloss{body(){const e=bios[this.xid];if(!e)return console.warn('missing bio:',this.xid);const t=`<img class="bio-img" src="/resources/shared/bios/${this.xid}.jpg"/>`;return t+e.bio}}registerElement('x-gloss',Gloss,{templateId:'#gloss'}),registerElement('x-bio',Bio,{templateId:'#gloss'});class Slider extends CustomElement{ready(){this.steps=+this.attr('steps'),this.speed=+this.attr('speed')||1,this.current=0,this.playing=!1;const e=this.$('.bar'),t=this.$('.knob');this.drag=new Draggable(t,e,'x',4),this.drag.on('start',()=>this.playing=!1),this.drag.on('move',(t)=>{const e=_Mathround(t.x/this.drag.width*this.steps);e===this.current||(this.trigger('move',e),this.current=e)}),this.drag.on('end',()=>this.trigger('slide-end'));const s=this.$('.play');this.hasAttr('no-play')?s.remove():s.on('click',()=>this.play()),this.on('attr:steps',(t)=>this.steps=+t.newAttr)}play(){if(this.playing)return;this.playing=!0,this.current>=this.steps&&this.set(0);const e=()=>{const t=this.drag.position.x;this.playing&&t<this.drag.width?window.requestAnimationFrame(e):this.playing&&(this.playing=!1,this.trigger('slide-end'));const s=_Mathmin(this.drag.width,t+2*this.speed);this.drag.position={x:s,y:0}};e()}set(e){this.drag.position={x:e*this.drag.width/this.steps,y:0}}moveTo(e,s=300){if(e===this.current)return;const t=this.current;animate((s)=>this.set(t+(e-t)*s),s).then(()=>this.trigger('slide-end'))}}registerElement('x-slider',Slider,{attributes:['steps'],templateId:'#slider'});class ImgSequence extends CustomElement{ready(){let e=this.attr('src'),t=+this.attr('pages')-1,s={width:this.attr('width'),height:this.attr('height')},i=$N('img',s,this),n=$N('x-slider',{steps:t},this),a=tabulate$1(()=>new Image,t);a.forEach((t,s)=>{t.src=e.replace('#',s)});const r=(s)=>{i.setAttr('src',e.replace('#',s)),s===t&&this.trigger('last')};n.on('move',r),r(0)}}registerElement('x-img-sequence',ImgSequence);let isOpen=!1,transform={},$activeImg=null;const $lightbox=$N('div',{class:'lightbox-overlay'},$body),$lightboxImg=$N('div',{class:'lightbox-img'},$lightbox);$lightbox.on('click',closeLightbox),Browser.onKey('escape',closeLightbox),$lightbox.on('scrollwheel touchmove',function(t){t.preventDefault(),t.stopPropagation()}),Browser.onKey('space up down left right pagedown pageup',function(t){isOpen&&(t.preventDefault(),t.stopPropagation())});class Media extends CustomElement{ready(){const e=this.attr('src'),t=this.$('.wrap'),s=this.attr('width'),n=this.attr('height');this.css('width',s+'px'),t.css('padding-bottom',100*(+n/+s)+'%');const i=t.$('img');i.setAttr('src',e);const a=t.$('.credit'),r=this.attr('credit');r?a.text=r:a.remove();const o=t.$('.zoom');if(this.hasAttr('lightbox')){this.addClass('interactive');const t=e.replace(/\.(?=[^.]*$)/,'-large.');this.on('click',()=>openLightbox(this,e,t))}else o.remove()}}registerElement('x-media',Media,{templateId:'#media'});class Notepad extends CustomElement{ready(){function e({x:e,y:t}){let n=$N('div',{contenteditable:'True'},s);n.css('left',e-6+'px'),n.css('top',t-26+'px'),n.focus(),i=n,n.on('blur',function(){n.text||n.remove()})}function t(e,t){if(!a){let e=$N('g',{},n);$N('line',{x1:t.x,y1:t.y,class:'stroke'},e),$N('line',{x1:t.x,y1:t.y,class:'halo'},e),e.on('pointerdown',function(){a=r=e,e.addClass('selected')}),e.on('clickAway',function(){e.removeClass('selected')}),a=e}a.children.forEach((t)=>{t.setAttr('x2',e.x),t.setAttr('y2',e.y)})}let s=this.$('.text'),n=this.$('svg'),i=null,a=null,r=null;slide(n,{start:function(){i&&i.blur(),i=a=null},move:function(e,s){if(r);else 10<Point.distance(s,e)?t(e,s):a&&(a.remove(),a=null)},end:function(t,s){!r&&10>Point.distance(s,t)&&e(t),r=null}})}}registerElement('x-notepad',Notepad,{template:'<div class="text"></div><svg></svg>'});class Parallax extends CustomElement{ready(){function e(a){if(!(a.top<n||a.top>i)){const e=(a.top-n)/(i-n)*(s?50:33);t.transform=`translateY(${e}%)`}}const t=this.$('.image'),s=50>this.positionTop;let n,i;t.css({"background-image":`url("${this.attr('background')}")`,height:s?'100%':'150%'});const a=({height:e})=>{const t=this.positionTop;n=_Mathmax(0,t-e),i=t+this.height};Browser.resize(a),$body.on('scroll',e)}}registerElement('x-parallax',Parallax,{templateId:'#parallax'});class Picker extends CustomElement{ready(){const e=this.getModel().$step;let t=0,s=0;this.children.forEach((n,a)=>{n.data.error||(e.goals.push('picker-'+a),t+=1),n.one('click',()=>{e.addHint(n.data.error?n.data.error:'correct'),n.addClass(n.data.error?'incorrect':'correct'),n.data.error||(e.score('picker-'+a),s+=1,t==s&&this.addClass('solved'))})})}}registerElement('x-picker',Picker);const MARGIN=15,MARGIN_TOP=100;class Popup extends CustomElement{ready(){this.isOpen=!1,this.$target=this.$('.target'),this.$box=this.$('.popup'),this.$bubble=this.$('.body');const e=()=>{this.isOpen?this.close():this.open()},t=()=>this.close();this.$target.on('click',e),this.on('clickOutside',t),this.clear=function(){this.$target.off('click',e),this.off('clickOutside',t)},this.on('detached',()=>this.close())}open(){if(!this.isOpen){this.isOpen=!0,this.$box.show();let e=this.$bubble.bounds,t=e.top-e.height,s=e.left-e.width/2,n=e.right+e.width/2,i=$body.offsetLeft;s<i+MARGIN&&this.$bubble.translateX(i+MARGIN-s);let a=i+$body.width;n>a-MARGIN&&this.$bubble.translateX(a-MARGIN-n),Browser.redraw(),t<MARGIN_TOP&&$body.scrollBy(t-MARGIN_TOP),this.$target.addClass('on'),this.$box.addClass('on')}}close(){this.isOpen&&(this.isOpen=!1,this.$target.removeClass('on'),this.$box.removeClass('on'),setTimeout(()=>this.$box.hide(),200))}}registerElement('x-popup',Popup,{templateId:'#popup'});const PADDING=12;class Progress extends CustomElement{ready(){this.r=+this.attr('r')||10,this.r1=this.r+PADDING,this.$svg=$N('svg',{width:2*this.r1,height:2*this.r1},this),this.completed=!1,this.$progress=$N('path',{class:'pie',d:getProgress(this.r),"stroke-width":this.r},this.$svg),this.setProgress(+this.attr('p'),!1)}setProgress(e,t=!0){if(.99<e)return this.complete(t);const s=_MathPI*this.r;this.$progress.css('stroke-dasharray',`${e*s} ${s}`)}complete(e=!0){if(this.completed)return;if(this.completed=!0,this.$progress.setAttr('class','done'),this.$progress.setAttr('d',getCheck(this.r)),!e)return;const t=$N('g',{transform:`translate(${this.r1} ${this.r1})`},this.$svg),n=tabulate$1(()=>$N('line',{},t),18);animate((e)=>{const t=this.r+PADDING*ease('quint-out',e),a=this.r+PADDING*e;for(let r=0;18>r;++r){const e=_Mathcos(2*_MathPI*r/18),i=_Mathsin(2*_MathPI*r/18);n[r].setLine({x:e*t,y:i*t},{x:e*a,y:i*a})}},800).then(()=>t.remove())}}registerElement('x-progress',Progress);class Slideshow extends CustomElement{ready(){this.$legend=this.$('.legend-box'),this.$steps=this.$legend.children,this.$back=this.$('.back'),this.$next=this.$('.next'),this.locked=!1;const e=this.$('.dots');this.$dots=this.$steps.map(()=>$N('div',{class:'dot'},e)),this.length=this.$steps.length,this.current=0;const t=this.$steps.map((e)=>words$1(e.data.needs||''));this.isReady=function(e){let s=t[this.current+1]||[];return s.every((t)=>e.scores.has(t))},this.$back.on('click',()=>this.goBack()),this.$next.on('click',()=>this.goNext()),this.$steps[0].show(),this.$dots[0].addClass('on')}go(e){if(!(this.locked||0>e||e>this.length-1||e===this.current)){this.locked=!0,setTimeout(()=>this.locked=!1,600),this.$back.setClass('disabled',0===e),this.$next.setClass('disabled',e===this.length-1),this.$dots[this.current].removeClass('on'),this.$dots[e].addClass('on'),this.$steps[e].show();const t=this.$steps[e].height+'px';this.$steps[e].hide(),this.$steps[this.current].exit('fade',300).then(()=>this.$steps[e].enter('fade'),300),this.$legend.animate({height:t},600).then(()=>this.$legend.css('height','auto')),this.current=e,this.trigger('step',e)}}goNext(){this.locked||(this.go(this.current+1),this.trigger('next',this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger('back',this.current))}}registerElement('x-slideshow',Slideshow,{templateId:'#slideshow'});const colours=loop$1(Colour.rainbow(8)),images=loop$1(['badge','homework','laurels','lightbulb','owl','scroll','trophy']);class Solved extends CustomElement{ready(){this.visible=!1,this.$svg=this.$('use'),this.$text=this.$('.message'),this.$step=this.getModel().$step,this.on('click',()=>this.exit())}enter(){if(!this.visible){this.visible=!0;const e=this.$step.addHint('correct'),t=colours(),s=images();this.css('background-color',t),this.$text.text=e.text.replace(/<.*>/,''),this.$svg.setAttr('xlink:href','/sketch.svg#'+s),Browser.replaceSvgImports(),enter(this,'pop',300,600)}}exit(){this.visible&&(this.visible=!1,exit(this,'pop',300))}}registerElement('x-solved',Solved,{templateId:'#solved'});class Sortable extends CustomElement{ready(){this.items=this.children.map((e)=>new Draggable(e,this,'y',0,!0));const e=(e=null)=>{let t=cumulative$1(this.items.map((e)=>e.h+10));this.items.forEach(function(s,n){s!==e&&(s.position={y:t[n-1]||0})})},t=()=>this.items.every((e,t)=>+e.$el.data.index===t)||this.items.every((e,t)=>+e.$el.data.index==this.items.length-t-1);for(let s of this.items)s.on('drag',()=>{this.items=sortByFn$1(this.items,(e)=>e.position.y-(e===s?10:0)),e(s)}),s.on('end',()=>{e(),t()&&this.solve()});Browser.resize(()=>{for(let e of this.items)e.h=e.$el.height;const t=total$1(this.items.map((e)=>e.h));this.css('height',t+10*this.items.length-10+'px'),e()})}solve(){this.trigger('solve'),this.addClass('solved');for(let e of this.items)e.disabled=!0}}registerElement('x-sortable',Sortable);const colours$1=loop$1(['#b30469','#1f7aff','#31b304','#ff941f']);class Particle{constructor(e){this.x=Math.random()*Browser.width,this.y=(Math.random()-1)*Browser.height,this.r=uniform(10,30),this.color=colours$1(),this.index=e,this.tilt=_Mathfloor(10*Math.random())-10,this.tiltAngleIncrement=.07*Math.random()+.05,this.tiltAngle=0}draw(e){e.beginPath(),e.lineWidth=this.r/2,e.strokeStyle=this.color,e.moveTo(this.x+this.tilt+this.r/4,this.y),e.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),e.stroke()}update(e,t){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(_Mathcos(e)+3+this.r/2)/2,this.x+=_Mathsin(e),this.tilt=15*_Mathsin(this.tiltAngle-this.index/3),-20>this.x?(this.x=-20,this.y=Math.random()*Browser.height,this.tilt=_Mathfloor(10*Math.random())-20):this.x>Browser.width+20?(this.x=Browser.width+20,this.y=Math.random()*Browser.height,this.tilt=_Mathfloor(10*Math.random())-20):t&&this.y>Browser.height&&(this.x=Math.random()*Browser.width,this.y=-10,this.tilt=_Mathfloor(10*Math.random())-20)}}const style='position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999';let $confetti;const stepFunctions=window._stepFunctions||{};class Step extends CustomElement{created(){this.isShown=!1,this.isCompleted=!1,this.goals=words$1(this.attr('goals')||''),this.scores=new Set,this.model=observable({$step:this}),this.tools={confetti}}ready(){this.$course=(this.getModel()||{}).$course,this.$blanks=this.$$('x-blank, x-blank-input'),this.$blanks.forEach((e,t)=>{this.goals.push('blank-'+t),e.on('valid',()=>{this.addHint('correct'),this.score('blank-'+t)}),e.on('invalid',()=>this.addHint('incorrect')),e.on('hint',(e)=>this.addHint(`Hmmm… maybe try ${e}?`))}),this.$equations=this.$$('x-equation'),this.$equations.forEach((e,t)=>{this.goals.push('eqn-'+t),e.on('solve',()=>{this.addHint('correct'),this.score('eqn-'+t)})}),this.$reveals=this.$$('.reveal');for(let e of this.$reveals)e.data.display='visibility',this.onScore(e.data.when,()=>{'visible'===e.css('visibility')||e.enter(e.data.animation||'fade',400,+e.data.delay||0)});this.$nextBtn=this.$$('.next-step'),this.$nextBtn.forEach((e,t)=>{this.goals.push('next-'+t),this.onScore('next-'+t,()=>e.exit('pop')),e.one('click',()=>this.score('next-'+t))});for(let e of this.$$('.check[data-when]'))this.onScore(e.data.when,()=>e.addClass('visible'));for(const e of this.$$('.step-target'))e.on('hover',{enter:()=>{const t=this.$$('[target~="'+e.data.to+'"]');for(let e of t)e.addClass('focus');this.addClass('focus')},exit:()=>{for(let e of this.$$('.focus'))e.removeClass('focus');this.removeClass('focus')}});this.$slides=this.$('x-slideshow'),this.$slides&&(this.goals.push(...tabulate$1((e)=>'slide-'+e,this.$slides.length-1)),this.$slides.on('next',(e)=>this.score('slide-'+(e-1)))),this.$sortables=this.$$('x-sortable'),this.$sortables.forEach((e,t)=>{this.goals.push('sortable-'+t),e.on('solve',()=>{this.addHint('correct'),this.score('sortable-'+t)})}),this.$gameplay=this.$('x-gameplay'),this.$gameplay&&(this.goals.push('gameplay'),this.$gameplay.on('score',()=>this.score('gameplay'))),this.$$('x-slider').forEach((e,t)=>{this.goals.push('slider-'+t),e.on('slide-end',()=>this.score('slider-'+t))}),this.$$('x-var').forEach((e,t)=>{this.goals.push('var-'+t),e.on('slide-end',()=>this.score('var-'+t))});for(let e of this.$$('.var'))e.bindObservable(this.model,!1)}show(e){if(!this.isShown){this.isShown=!0;try{const e=toCamelCase$1(this.id);e in stepFunctions&&stepFunctions[e](this)}catch(t){console.error(t)}e&&this.restore(e),setTimeout(()=>{if(!this.isReady)for(let e of this.$$('x-gesture'))'X-GEOPAD'!==e.parent.tagName&&e.start()},2e3),this.$course&&this.$course.log('Step','show',this.id),this.addClass('on'),Browser.resize()}}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let e of this.$reveals)'visible'!==e.css('visibility')&&e.enter('fade',400);for(let e=0;e<this.$nextBtn.length;++e)this.score('next-'+e);this.trigger('complete')}}restore(e){this.$blanks.forEach((t,s)=>{0<=e.scores.indexOf('blank-'+s)&&t.solve()}),this.$equations.forEach((t,s)=>{0<=e.scores.indexOf('eqn-'+s)&&t.solve()}),this.$sortables.forEach((t,s)=>{0<=e.scores.indexOf('sortable-'+s)&&t.solve()}),e.scores.forEach((e)=>this.score(e,!1))}get isReady(){return this.goals.every((e)=>this.scores.has(e))}score(e,t=!0){this.scores.has(e)||(this.scores.add(e),this.trigger('score-'+e),this.trigger('score'),this.$course&&(this.$course.trigger('score'),this.$course.saveProgress({steps:{[this.id]:{scores:[e]}}}),this.$course.log('Step','score',this.id+'/'+e)),t&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout(()=>{this.$course.$activeStep===this&&this.$course.nextStep()},500))}onScore(e,t){if(e=words$1(e),e.every((e)=>this.scores.has(e)))return t();if(1===e.length)return this.one('score-'+e[0],t);const s=()=>{e.every((e)=>this.scores.has(e))&&(t(),this.off('score',s))};this.on('score',s)}addHint(e,t={}){return this.trigger('hint',e),this.$course&&this.$course.isReady?this.isInViewport?this.$course.$tutor.showHint(e,t):(this.on('enterViewport',()=>this.$course.$tutor.showHint(e,t)),this.$course.$tutor.hints[e]||e):e}getHelp(){}delayedHint(e,s=1e4){let t=setTimeout(e,s);this.on('score',()=>{clearTimeout(t),this.isCompleted||(t=setTimeout(e,2e4))}),this.on('complete',()=>clearTimeout(t))}}registerElement('x-step',Step);class Tabbox extends CustomElement{ready(){const e=this.$('.titles');this.$body=this.$('.body'),this.$tabs=this.$$('.tab'),this.$titles=[],this.active=0;for(let t=0;t<this.$tabs.length;++t){const s=this.$tabs[t].$('h3')||$N('h3');e.append(s),this.$titles.push(s),s.on('click',()=>this.makeActive(t))}this.$titles[0].addClass('active'),this.$tabs[0].show()}makeActive(e){if(this.active!==e){this.$titles[this.active].removeClass('active'),this.$titles[e].addClass('active'),this.$tabs[e].show();const t=this.$tabs[e].outerHeight+'px';this.$tabs[e].hide(),this.$tabs[this.active].exit('fade',300).then(()=>this.$tabs[e].enter('fade',300)),this.$body.animate({height:t},600).then(()=>this.$body.css('height','auto')),this.active=e,this.trigger('change',e)}}}const template='<div class="titles"></div><div class="body"><slot></slot></div>';registerElement('x-tabbox',Tabbox,{template});const $fixed=$$('header, x-tutor, .sidebar'),$targets=$N('svg',{class:'target-body',style:`position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; pointer-events: none; z-index: 900; opacity: 0;
            transform: translateZ(0); will-change: opacity; transition: opacity .3s;`,html:`<defs>
      <mask id="masking"><rect width="100%" height="100%" fill="white"/></mask>
    </defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z"/>
    </marker>
    <rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" fill="white" opacity="0.9"/>
    <path id="target-arrow" stroke="black" stroke-width="5" marker-end="url(#arrow)" opacity="0.3" stroke-linecap="round"/>`},$body),$mask=$targets.$('mask'),$arrow=$targets.$('#target-arrow');let active$1=!1,$bounds=[];class Target extends CustomElement{ready(){function t(){active$1=!0;let t=$$(r);if(t.length){let s=t[0].hasParent(...$fixed);null==e&&(e=a.hasParent(...$fixed));let n=a.bounds,i=t.map((e)=>e.bounds).filter((e)=>e.width||e.height);if(d=0,!s){let e=_Mathmin(...i.map((e)=>e.top)),t=_Mathmax(...i.map((e)=>e.top+e.height)),s=Browser.height-20-t,n=60-e;d=0>s?s:0<n?n:0}$bounds.forEach((e)=>{e.remove()}),$bounds=[n].concat(i).map(function(t,s){let n=s&&!o?10:4;return $N('rect',{x:t.left-n,y:t.top-n+(s||!e?d:0),width:t.width+2*n,height:t.height+2*n,rx:4,ry:4},$mask)}),$arrow.points=connect(n,i[0],e?0:d,s?0:d)}}function s(){d&&$body.scrollBy(-d,300),$targets.css('display','block'),Browser.redraw(),delay$1(function(){$targets.css('opacity',1)},d?300:0)}function n(t){if(active$1){let e='mousemove'===t.type||'pointermove'===t.type;e&&40>distance(l,[t.clientX,t.clientY])||(clearTimeout(p),active$1=!1,$targets.css('opacity',0),setTimeout(function(){active$1||$targets.css('display','none')},300),$body.off('mousewheel mousemove touchend touchmove',n),a.off('mouseleave',n))}}function i(){d&&!e?$body.on('mousemove',n):a.on('mouseleave',n),$body.on('mousewheel touchend touchmove',n)}const a=this;let e,r=a.attr('to'),o=a.hasAttr('no-margins'),l=null,d=null,p=null;a.on('mouseenter touchstart',function(n){l=[n.clientX,n.clientY],t(),p=setTimeout(s,d?50:30),i()}),a.on('click',function(t){active$1?(t.handled=!0,n({}),setTimeout(function(){$(r).trigger('click mousedown')})):(active$1=!0,d=0,s(),i())})}}registerElement('x-target',Target);const MATHS_REGEX=/[0-9+\-*/()^\s]+/g,WELCOME='Welcome to Mathigon! I\u2019m Archie, your personal tutor.',CREATE_ACCOUNT='Remember to <x-target to=".nav-link.dropdown-title">create an account</x-target>, to save your progress and see personalised content.',TUTORIAL=['Welcome to Mathigon! The content is divided into small steps, and you have to answer questions or solve puzzles to reveal the next one.','We will save all your progress, so you can come back later and continue right where you left off.'];let CORRECT=loop$1(shuffle(['Well done :263a:','Great Work! :1f60c:','Awesome :1f600:','Brilliant :1f44d:','Excellent! :1f44c:','Cool :1f60e:','Nice! :270c:','Way to go! :1f60a:','Impressive! :1f3c6:','Outstanding :1f947:','Superb! :2b50:','Wonderful!'])),INCORRECT=loop$1(shuffle(['That\u2019s not quite right :2639:','Are you sure about that? :1f914:','That doesn\u2019t look right. :1f62f:','Try again! :1f615:']));class Tutor extends CustomElement{created(){this.recentMessages=[],this.isOpen=!1,this.queuePromise=Promise.resolve()}ready(){this.$course=(this.getModel()||{}).$course,this.hints=JSON.parse($('#hints').text)||{},this.$toasts=this.$('.toasts'),this.$chat=this.$('.chat'),this.$chatBody=this.$('.chat-body'),this.$toasts.on('click',(t)=>{t.handled||this.open()}),this.$('.close').on('click',()=>this.close());const t=this.$('.chat-footer .input');t.onKeyDown('enter',(s)=>{s.preventDefault(),this.askQuestion(t.text.trim()),t.text=''}),this.$('.hint').on('click',()=>{this.queue(TUTORIAL[0]),this.queue(this.$course.user?TUTORIAL[1]:CREATE_ACCOUNT)})}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter('slide-up',200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger('open'))}close(){this.isOpen&&(this.isOpen=!1,this.trigger('close'),this.$chat.exit('slide-down',200))}queue(e,t,s){this.queuePromise=this.queuePromise.then(()=>(this.display(e,t,s),wait$1(500)))}display(e,t='hint',{timeout:n=8e3,toast:i=!0,className:s}={}){if(640>Browser.width&&(n*=.7),i&&!this.isOpen){const i=createMsgElement(e,t,{className:s});this.$toasts.append(i),i.enter('reveal-right'),n&&setTimeout(()=>i.exit('reveal-right',400,0,!0),n),this.on('open',()=>i.exit('reveal',200,0,!0))}const a=createMsgElement(e,t,{className:s,visible:!this.isOpen});this.$chatBody.append(a),this.isOpen&&(a.enter('reveal',300),animate(()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight,200))}showHint(e,{store:t=!0,force:s=!1,className:n=null}={}){if(isOneOf$1(e,'correct','incorrect')){const t=parseEmoji('correct'===e?CORRECT():INCORRECT());return this.queue(t,'hint',{className:n||e}),{text:t}}const i=this.hints[e]||e;return!s&&0<=this.recentMessages.indexOf(e)?{text:i}:(this.recentMessages.push(e),setTimeout(()=>this.recentMessages.shift(),1e4),t&&this.$course.saveProgress({hints:[{content:i,kind:'hint'}]}),this.queue(i,'hint',{className:n}),{text:i})}askQuestion(query){this.queue(query,'question'),this.$course&&this.$course.log('Tutor','ask',query);const equation=(query.match(MATHS_REGEX)||[]).filter((e)=>3<=e.length&&!e.match(/^[\s0-9]+$/));if(equation.length)try{const result=eval(equation[0].replace(/\b0+/g,'0').replace(/\^/g,'**'));return this.queue('= '+result)}catch(t){console.error('Parse Error:',equation[0])}}}registerElement('x-tutor',Tutor,{templateId:'#tutor'});class Variable extends CustomElement{ready(){const e=this,t=e.attr('bind');if(!t)return;let s=t.split('|'),n=s[0],i=s[1],a=s[2],r=a.split(',').map((e)=>+e),o=r[0],l=r[1],d=r[2],p=+i;const c=this.getModel();c.set(n,p),this.$('.content').bindObservable(c);let h=e.$('.progress');h.css('width',116*(+p-o)/(l-o)+'px');let g=0,u=0,m=_Mathsqrt(1e3*(d/(l-o)))+(Browser.isTouch?10:2),x=!1;slide(e,{start(t){g=t.x,u=p,e.addClass('on'),x=!1},move(e){let t=e.x-g,s=roundTo(clamp$1(u+t/m,o,l),d);s=_round(s,2),s===p||(p=s,x=!0,c&&c.set(n,p),h.css('width',116*(p-o)/(l-o)+'px'))},end(){e.removeClass('on'),x&&e.trigger('slide-end')}})}}registerElement('x-var',Variable,{templateId:'#var',model:!0});class Video extends CustomElement{ready(){const e=this.attr('src'),t=this.$('.video-wrap'),s=this.$('video'),n=this.attr('width'),i=this.attr('height');this.css('width',n+'px'),t.css('padding-bottom',100*(+i/+n)+'%'),s.setAttr('poster',this.attr('poster')||e.replace(/mp4$/,'jpg')),this.hasAttr('loop')&&(s._el.loop=!0),this.hasAttr('audio')||(s._el.muted=!0),$N('source',{src:e,type:'video/mp4'},s),this.hasAttr('credit')&&(this.$('.credit').text=this.attr('credit'));const a=this.$('.bar'),r=this.$('.progress'),o=this.$('.buffer'),l=this.$('.timecode'),d=new Draggable(this.$('.handle'),this.$('.bar'),'x'),p=this._video=s._el;let c=this.width-110;Browser.resize(()=>c=this.width-110),s.on('canplay',()=>{l.text=formatTime(p.duration)}),s.on('timeupdate',()=>{const e=p.currentTime/p.duration;r.css('width',100*e+'%'),l.text=formatTime(p.currentTime),d.position={x:e*c,y:0},this.trigger('timeupdate',p.currentTime)}),s.on('progress',()=>{if(!(0>=p.buffered.length||0>=p.duration)){const e=p.buffered.end(p.buffered.length-1),t=100*(e/p.duration);o.css('width',t+'%')}}),s.on('ended',()=>{p.pause(),this.removeClass('playing'),this.trigger('end')});const h=()=>p.paused?this.play():this.pause(),g=(e)=>this.setTime(e/c*p.duration);this.hasAttr('hover')?(s.on('mouseover touchdown',()=>this.play()),s.on('mouseout touchup',()=>this.pause())):s.on('click',h),this.hasAttr('controls')&&(this.$('.controls').show(),this.$('.play-pause-btn').on('click',h),d.on('drag',()=>g(d.position.x)),a.on('click',(t)=>g(t.offsetX)))}setTime(e){this._video.currentTime=e}play(){this._video.play(),this.addClass('playing')}pause(){this._video.pause(),this.removeClass('playing')}}registerElement('x-video',Video,{templateId:'#video'});class Dropdown extends CustomElement{ready(){this.$title=this.$('.dropdown-title'),this.$body=this.$('.dropdown-body'),this.isOpen=!1,this.$title.on('click',()=>{this.toggle()}),this.$$('a').forEach((e)=>{e.on('click',()=>{this.hide()})}),this.on('clickOutside',()=>{this.hide()})}show(){this.isOpen||(this.isOpen=!0,this.addClass('open'),this.$body.enter('fade',200))}hide(){this.isOpen&&(this.isOpen=!1,this.removeClass('open'),this.$body.exit('fade',200))}toggle(){this.isOpen?this.hide():this.show()}}registerElement('x-dropdown',Dropdown);const $modalBackground=$N('div',{class:'modal-background'},$body);let $openModal=null;$modalBackground.on('click',tryClose),Browser.onKey('escape',tryClose),$modalBackground.on('scrollwheel touchmove',function(t){t.preventDefault(),t.stopPropagation()}),Browser.onKey('space up down pagedown pageup',function(t){$openModal&&(t.preventDefault(),t.stopPropagation())});class Modal extends CustomElement{ready(){this.isOpen=!1,this.canClose=!this.hasAttr('no-close');const e=$$(`[data-modal=${this.id}]`);for(let t of e)t.on('click',()=>this.open());this.hasClass('open')&&!$openModal&&($modalBackground.show(),this.show(),this.isOpen=!0,$openModal=this);const t=this.$('.close');t&&t.on('click',()=>this.close())}open(){this.isOpen||($openModal?$openModal.close(!0):$modalBackground.enter('fade',250),this.isOpen=!0,$openModal=this,this.enter('pop',250))}close(e=!1){this.isOpen&&(this.isOpen=!1,$openModal=null,!e&&$modalBackground.exit('fade',250),this.exit('pop',250))}}registerElement('x-modal',Modal);class Select extends CustomElement{ready(){const e=this.children;this.$active=this.$('.active')||e[0],this.$active.addClass('active');for(let t of e)t.on('click',()=>this.makeActive(t));this.trigger('change',this.$active)}makeActive(e){e===this.$active||(this.$active.removeClass('active'),this.$active=e,e.addClass('active'),this.trigger('change',e))}}registerElement('x-select',Select);const VERSION='2.4.1',DEV_ID='i5iSjo',VERSION_PARAM='_av',USAGE_PARAM='_au',NULL_DIMENSION='(not set)',instances=[];class MethodChain{static add(e,t,s){getOrCreateMethodChain(e,t).add(s)}static remove(e,t,s){getOrCreateMethodChain(e,t).remove(s)}constructor(e,t){this.context=e,this.methodName=t,this.isTask=/Task$/.test(t),this.originalMethodReference=this.isTask?e.get(t):e[t],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...e)=>{const t=this.boundMethodChain[this.boundMethodChain.length-1];return t(...e)},this.isTask?e.set(t,this.wrappedMethod):e[t]=this.wrappedMethod}add(e){this.methodChain.push(e),this.rebindMethodChain()}remove(e){const t=this.methodChain.indexOf(e);-1<t&&(this.methodChain.splice(t,1),0<this.methodChain.length?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let e,t=0;e=this.methodChain[t];t++){const s=this.boundMethodChain[t-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(e(s))}}destroy(){const e=instances.indexOf(this);-1<e&&(instances.splice(e,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}}const proto=window.Element.prototype,nativeMatches=proto.matches||proto.matchesSelector||proto.webkitMatchesSelector||proto.mozMatchesSelector||proto.msMatchesSelector||proto.oMatchesSelector,a=document.createElement('a'),queueMap={},assign=Object.assign||function(e,...t){for(let s=0,n=t.length;s<n;s++){const n=Object(t[s]);for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},uuid=function e(t){return t?(t^16*Math.random()>>t/4).toString(16):'10000000-1000-4000-8000-100000000000'.replace(/[018]/g,e)};class EventEmitter{constructor(){this.registry_={}}on(e,t){this.getRegistry_(e).push(t)}off(e=void 0,t=void 0){if(e&&t){const s=this.getRegistry_(e),n=s.indexOf(t);-1<n&&s.splice(n,1)}else this.registry_={}}emit(e,...t){this.getRegistry_(e).forEach((e)=>e(...t))}getEventCount(){let e=0;return Object.keys(this.registry_).forEach((t)=>{e+=this.getRegistry_(t).length}),e}getRegistry_(e){return this.registry_[e]=this.registry_[e]||[]}}const AUTOTRACK_PREFIX='autotrack',instances$1={};let browserSupportsLocalStorage,isListening=!1;class Store extends EventEmitter{static getOrCreate(e,t,s){const n=[AUTOTRACK_PREFIX,e,t].join(':');return instances$1[n]||(instances$1[n]=new Store(n,s),!isListening&&initStorageListener()),instances$1[n]}static isSupported_(){if(null!=browserSupportsLocalStorage)return browserSupportsLocalStorage;try{window.localStorage.setItem(AUTOTRACK_PREFIX,AUTOTRACK_PREFIX),window.localStorage.removeItem(AUTOTRACK_PREFIX),browserSupportsLocalStorage=!0}catch(e){browserSupportsLocalStorage=!1}return browserSupportsLocalStorage}static get_(e){return window.localStorage.getItem(e)}static set_(e,t){window.localStorage.setItem(e,t)}static clear_(e){window.localStorage.removeItem(e)}constructor(e,t={}){super(),this.key_=e,this.defaults_=t,this.cache_=null}get(){if(this.cache_)return this.cache_;if(Store.isSupported_())try{this.cache_=parse$1(Store.get_(this.key_))}catch(e){}return this.cache_=assign({},this.defaults_,this.cache_)}set(e){if(this.cache_=assign({},this.defaults_,this.cache_,e),Store.isSupported_())try{Store.set_(this.key_,JSON.stringify(this.cache_))}catch(e){}}clear(){if(this.cache_={},Store.isSupported_())try{Store.clear_(this.key_)}catch(e){}}destroy(){delete instances$1[this.key_],Object.keys(instances$1).length||removeStorageListener()}}const SECONDS=1e3,MINUTES=60*SECONDS,instances$2={};class Session{static getOrCreate(e,t,s){const n=e.get('trackingId');return instances$2[n]?instances$2[n]:instances$2[n]=new Session(e,t,s)}constructor(e,t,s){this.tracker=e,this.timeout=t||Session.DEFAULT_TIMEOUT,this.timeZone=s,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),MethodChain.add(e,'sendHitTask',this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat('en-US',{timeZone:this.timeZone})}catch(e){}this.store=Store.getOrCreate(e.get('trackingId'),'session',{hitTime:0,isExpired:!1}),this.store.get().id||this.store.set({id:uuid()})}getId(){return this.store.get().id}isExpired(e=this.getId()){if(e!=this.getId())return!0;const t=this.store.get();if(t.isExpired)return!0;const s=t.hitTime;if(s){const e=new Date,t=new Date(s);if(e-t>this.timeout*MINUTES||this.datesAreDifferentInTimezone(e,t))return!0}return!1}datesAreDifferentInTimezone(e,t){return!!this.dateTimeFormatter&&this.dateTimeFormatter.format(e)!=this.dateTimeFormatter.format(t)}sendHitTaskOverride(e){return(t)=>{e(t);const s=t.get('sessionControl'),n='start'==s||this.isExpired(),i=this.store.get();i.hitTime=now(),n&&(i.isExpired=!1,i.id=uuid()),'end'==s&&(i.isExpired=!0),this.store.set(i)}}destroy(){MethodChain.remove(this.tracker,'sendHitTask',this.sendHitTaskOverride),this.store.destroy(),delete instances$2[this.tracker.get('trackingId')]}}Session.DEFAULT_TIMEOUT=30;const plugins={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},PLUGIN_COUNT=Object.keys(plugins).length,HIDDEN='hidden',VISIBLE='visible',PAGE_ID=uuid(),SECONDS$1=1e3;class PageVisibilityTracker{constructor(e,t){if(trackUsage(e,plugins.PAGE_VISIBILITY_TRACKER),!!document.visibilityState){const s={sessionTimeout:Session.DEFAULT_TIMEOUT,visibleThreshold:5*SECONDS$1,sendInitialPageview:!1,fieldsObj:{}};this.opts=assign(s,t),this.tracker=e,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=Store.getOrCreate(e.get('trackingId'),'plugins/page-visibility-tracker'),this.store.on('externalSet',this.handleExternalStoreSet),this.session=Session.getOrCreate(e,this.opts.sessionTimeout,this.opts.timeZone),MethodChain.add(e,'set',this.trackerSetOverride),window.addEventListener('unload',this.handleWindowUnload),document.addEventListener('visibilitychange',this.handleChange),deferUntilPluginsLoaded(this.tracker,()=>{document.visibilityState==VISIBLE?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:now(),state:VISIBLE,pageId:PAGE_ID,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}}handleChange(){if(document.visibilityState!=VISIBLE&&document.visibilityState!=HIDDEN)return;const e=this.getAndValidateChangeData(),t={time:now(),state:document.visibilityState,pageId:PAGE_ID,sessionId:this.session.getId()};document.visibilityState==VISIBLE&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==HIDDEN&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(e.sessionId)?(this.store.clear(),this.lastPageState==HIDDEN&&document.visibilityState==VISIBLE&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(t),this.sendPageview({hitTime:t.time})},this.opts.visibleThreshold))):(e.pageId==PAGE_ID&&e.state==VISIBLE&&this.sendPageVisibilityEvent(e),this.store.set(t)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){const e=this.store.get();return this.lastPageState==VISIBLE&&e.state==HIDDEN&&e.pageId!=PAGE_ID&&(e.state=VISIBLE,e.pageId=PAGE_ID,this.store.set(e)),e}sendPageVisibilityEvent(e,{hitTime:t}={}){const s=this.getTimeSinceLastStoredChange(e,{hitTime:t});if(s&&s>=this.opts.visibleThreshold){const e=_Mathround(s/SECONDS$1),n={transport:'beacon',nonInteraction:!0,eventCategory:'Page Visibility',eventAction:'track',eventValue:e,eventLabel:NULL_DIMENSION};t&&(n.queueTime=now()-t),this.opts.visibleMetricIndex&&(n['metric'+this.opts.visibleMetricIndex]=e),this.tracker.send('event',createFieldsObj(n,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){const e={transport:'beacon',eventCategory:'Page Visibility',eventAction:'page load',eventLabel:NULL_DIMENSION,['metric'+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send('event',createFieldsObj(e,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:e,isPageLoad:t}={}){const s={transport:'beacon'};e&&(s.queueTime=now()-e),t&&this.opts.pageLoadsMetricIndex&&(s['metric'+this.opts.pageLoadsMetricIndex]=1),this.tracker.send('pageview',createFieldsObj(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(e){return(t,s)=>{const n=isObject$2(t)?t:{[t]:s};n.page&&n.page!==this.tracker.get('page')&&this.lastPageState==VISIBLE&&this.handleChange(),e(t,s)}}getTimeSinceLastStoredChange(e,{hitTime:t}={}){return e.time?(t||now())-e.time:0}handleExternalStoreSet(e,t){e.time!=t.time&&(t.pageId!=PAGE_ID||t.state!=VISIBLE||this.session.isExpired(t.sessionId)||this.sendPageVisibilityEvent(t,{hitTime:e.time}))}handleWindowUnload(){this.lastPageState!=HIDDEN&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),MethodChain.remove(this.tracker,'set',this.trackerSetOverride),window.removeEventListener('unload',this.handleWindowUnload),document.removeEventListener('visibilitychange',this.handleChange)}}provide('pageVisibilityTracker',PageVisibilityTracker),window.$=$,window.$$=$$,window.Browser=Browser,Browser.replaceSvgImports(),setTimeout(()=>{$html.addClass('ready')}),$html.addClass((Browser.isMobile?'is':'not')+'-mobile');class Course extends CustomElement{created(){this.model={$course:this},this.user=window.user,this.isCompleted=!1,this.isReady=!1,this.glossary=JSON.parse(this.$('#glossary').text)||{},this.userData=JSON.parse(this.$('#userdata').text)||{},this.$steps=this.$$('x-step'),this.$activeStep=null}ready(){this.$footer=this.$('footer'),this.$skipStep=this.$footer.$('.skip-step'),this.$progress=this.$('.sidebar-row.on x-progress'),this.$tutor=this.$('x-tutor');const e=this.$('.sidebar');this.$('.sidebar-toggle').on('click',()=>e.addClass('open')),this.$('.sidebar-shadow').on('pointerdown',()=>e.removeClass('open'));const t=this.userData.steps||{},s=this.findStep(Browser.hash);this.$activeStep=this.findStep(this.userData.activeStep)||this.$steps[0];for(let e of this.$steps){if(e.show(t[e.id]),e===this.$activeStep)break;e.complete()}if(this.userData.completed||'full'===Browser.hash)this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();s?this.goToStep(s,!1):this.$activeStep&&this.userData.activeStep&&this.goToStep(this.$activeStep,!1),this.$('.section-dev')&&this.complete(),Browser.onKey('space',(t)=>{t.preventDefault(),this.nextStep()}),this.$footer.$('.skip').on('click',()=>this.nextStep()),this.isReady=!0,setTimeout(()=>this.addClass('ready'))}nextStep(){if(this.isCompleted)return;let e=this.$activeStep;this.animateSkipStepBanner();do{if(e.complete(),e=this.$steps[this.$steps.indexOf(e)+1],!e)return this.complete(!0);e.show()}while(e.isReady);this.$activeStep=e,this.saveProgress({activeStep:e.id})}goToStep(e,t=!0){t&&this.animateSkipStepBanner();for(let s of this.$steps){if(s.show(),e.isShown&&!s.isReady){this.$activeStep=s;break}s.complete()}const s=e.positionTop-_Mathmax(50,(Browser.height-e.height)/2);t?$body.scrollTo(s):$body.scrollTop=s;const n=last$1(this.$steps);return n.isShown&&n.isReady?this.complete():void this.saveProgress({activeStep:this.$activeStep.id})}complete(e=!1){if(!this.isCompleted){this.isCompleted=!0,this.$steps.forEach((e)=>e.complete()),this.$activeStep=null;const t=this.$footer.$('.next-section');e?(this.$skipStep.exit('fade',200),t&&t.enter('pop')):(this.$skipStep.hide(),t&&t.show()),this.saveProgress({completed:!0}),this.log('Course','complete')}}findStep(e){for(let t of this.$steps)if(t.id===e)return t}animateSkipStepBanner(){this.$skipStep.css({top:this.$skipStep.bounds.top+'px',width:this.$skipStep.width+'px'}),this.$skipStep.addClass('fixed'),this.$skipStep.animate({transform:'translateY(100px)'}).then(()=>{this.$skipStep.removeClass('fixed'),this.$skipStep.css({top:'',width:'',transform:''})})}saveProgress(){}log(e=null){}}return registerElement('x-course',Course),exports.Course=Course,exports}({});
